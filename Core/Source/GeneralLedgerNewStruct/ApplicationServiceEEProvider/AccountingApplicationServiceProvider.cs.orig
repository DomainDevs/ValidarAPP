<<<<<<< HEAD
﻿using Sistran.Core.Application.GeneralLedgerServices.EEProvider.Models;
using Sistran.Core.Framework.BAF;

=======
﻿using System;
using System.Collections;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Globalization;
using System.Linq;

//Sistran FWK
using Sistran.Core.Framework.BAF;
using Sistran.Core.Framework.DAF;
using Sistran.Core.Framework.SAF;
using Sistran.Core.Framework.Contexts;
using Sistran.Core.Framework.DAF.Engine;
using Sistran.Core.Framework.DAF.Engine.Factories;
using Sistran.Core.Framework.Queries;
using Sistran.Core.Framework.Transactions;
using Sistran.Core.Framework.Views;

//Sitran Core
using Sistran.Core.Application.UniquePersonService.V1.Models;
using Sistran.Core.Application.CommonService;
using CommonModels = Sistran.Core.Application.CommonService.Models;
using Sistran.Core.Application.GeneralLedgerServices.DTOs;
using Sistran.Core.Application.GeneralLedgerServices.DTOs.Rules;
using Sistran.Core.Application.GeneralLedgerServices.EEProvider.Enums;
using Sistran.Core.Application.GeneralLedgerServices.EEProvider.Assemblers;
using Sistran.Core.Application.GeneralLedgerServices.EEProvider.DAOs;
using Sistran.Core.Application.GeneralLedgerServices.EEProvider.Entities;
using GeneralLedgerModels = Sistran.Core.Application.GeneralLedgerServices.EEProvider.Models;
using ReclassificationModels = Sistran.Core.Application.GeneralLedgerServices.EEProvider.Models.AccountReclassification;
using AccountingConceptModels = Sistran.Core.Application.GeneralLedgerServices.EEProvider.Models.AccountingConcepts;
using Sistran.Co.Application.Data;
>>>>>>> 9c571d2e6dec9097a19f56fbc8fe20565362cb32
namespace Sistran.Core.Application.GeneralLedgerServices.EEProvider
{
    public class AccountingApplicationServiceProvider : IAccountingApplicationService
    {
        #region Instance Variables
        readonly internal static IDataFacadeManager _dataFacadeManager = AppConfigDataFacadeManagerFactory.SingletonInstance;
              
        #endregion Instance Variables

        #region Public Methods

        #region GL

        #region AccountingAccount

        /// <summary>
        /// Guarda una cuenta contable
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>GeneralLedgerModels.AccountingAccount</returns>
        public AccountingAccount SaveAccountingAccount(AccountingAccount accountingAccount)
        {
            try
            {
<<<<<<< HEAD
                AccountingAccount accountingAccountNew = _accountingAccountDAO.SaveAccountingAccount(accountingAccount);
=======
                AccountingAccountPrefixDAO accountingAccountPrefixDAO = new AccountingAccountPrefixDAO();
                AccountingAccountCostCenterDAO accountingAccountCostCenterDAO = new AccountingAccountCostCenterDAO();
                AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
                GeneralLedgerModels.AccountingAccount accountingAccountNew = accountingAccountDAO.SaveAccountingAccount(accountingAccount);
>>>>>>> 9c571d2e6dec9097a19f56fbc8fe20565362cb32

                accountingAccount.AccountingAccountId = accountingAccountNew.AccountingAccountId;
                // Se graba centro de costos y ramos asociados
                accountingAccount.AccountingAccountId = accountingAccountCostCenterDAO.UpdateAccountingCostCenterByAccountingAccount(accountingAccount);

                accountingAccount.AccountingAccountId = accountingAccountPrefixDAO.UpdateAccountingPrefixByAccountingAccount(accountingAccount);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingAccount;
        }

        /// <summary>
        /// UpdateAccountingAccount
        /// Actualiza una cuenta contable
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>AccountingAccount</returns>
        public GeneralLedgerModels.AccountingAccount UpdateAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            try
            {
                AccountingAccountPrefixDAO accountingAccountPrefixDAO = new AccountingAccountPrefixDAO();
                AccountingAccountCostCenterDAO accountingAccountCostCenterDAO = new AccountingAccountCostCenterDAO();
                AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
                // Se graba centro de costos y ramos asociados
                accountingAccount.AccountingAccountId = accountingAccountCostCenterDAO.UpdateAccountingCostCenterByAccountingAccount(accountingAccount);
                accountingAccount.AccountingAccountId = accountingAccountPrefixDAO.UpdateAccountingPrefixByAccountingAccount(accountingAccount);

                // Se actualiza la cuenta contable
                accountingAccount = accountingAccountDAO.UpdateAccountingAccount(accountingAccount);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingAccount;
        }

        /// <summary>
        /// DeleteAccountingAccount
        /// Borra una cuenta contable
        /// </summary>
        /// <param name="accountingAccountId"></param>
        /// <returns>bool</returns>
        public bool DeleteAccountingAccount(int accountingAccountId)
        {
            AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
            bool deleted = false;
            GeneralLedgerModels.AccountingAccount accountingAccount = GetAccountingAccount(accountingAccountId);

            try
            {
                if (DeleteCostCentersByAccountingAccount(accountingAccount) &&
                    DeletePrefixesByAccountingAccount(accountingAccount))
                {
                    deleted = accountingAccountDAO.DeleteAccountingAccount(accountingAccountId);
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return deleted;
        }

        /// <summary>
        /// GetAccountingAccount
        /// Obtiene datos de una cuenta contable
        /// </summary>
        /// <param name="accountingAccountId"></param>
        /// <returns>AccountingAccount</returns>
        public GeneralLedgerModels.AccountingAccount GetAccountingAccount(int accountingAccountId)
        {
            AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
            GeneralLedgerModels.AccountingAccount accountingAccount = accountingAccountDAO.GetAccountingAccount(accountingAccountId);

            accountingAccount = GetCostCentersByAccountingAccount(accountingAccount);
            accountingAccount = GetPrefixesByAccountingAccount(accountingAccount);
            return accountingAccount;
        }

        /// <summary>
        /// GetAccountingAccounts
        /// Obtiene todas las cuentas contables
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingAccount></returns>
        public List<GeneralLedgerModels.AccountingAccount> GetAccountingAccounts()
        {
            AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
            return accountingAccountDAO.GetAccountingAccounts();
        }

        /// <summary>
        /// GetAccountingAccountsByNumberDescription
        /// Obtiene una cuenta contable haciendo uso de su número de cuenta o descripción
        /// <param name="accountingAccount"></param>
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingAccount></returns>
        public List<GeneralLedgerModels.AccountingAccount> GetAccountingAccountsByNumberDescription(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            List<GeneralLedgerModels.AccountingAccount> filteredAccountingAccounts;

            try
            {
                // Creación del filtro 
                var criteriaBuilder = new ObjectCriteriaBuilder();
                if (!string.IsNullOrEmpty(accountingAccount.Number))
                {
                    criteriaBuilder.Property(AccountingAccount.Properties.AccountNumber);
                    criteriaBuilder.Like();
                    criteriaBuilder.Constant(accountingAccount.Number + "%");
                }

                if (!string.IsNullOrEmpty(accountingAccount.Description))
                {
                    criteriaBuilder.Or();
                    criteriaBuilder.Property(AccountingAccount.Properties.AccountName);
                    criteriaBuilder.Like();
                    criteriaBuilder.Constant(accountingAccount.Description);
                }

                // Asignamos BusinessCollection a una Lista
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(
                    typeof(AccountingAccount), criteriaBuilder.GetPredicate()));

                List<GeneralLedgerModels.AccountingAccount> accountingAccounts = new List<GeneralLedgerModels.AccountingAccount>();

                foreach (AccountingAccount accountingAccountEntity in businessCollection.OfType<AccountingAccount>())
                {
                    CommonModels.Branch branch = new CommonModels.Branch();
                    branch.Id = Convert.ToInt32(accountingAccountEntity.DefaultBranchCode);

                    CommonModels.Currency currency = new CommonModels.Currency();
                    currency.Id = Convert.ToInt32(accountingAccountEntity.DefaultCurrencyCode);

                    GeneralLedgerModels.Analysis analysis = new GeneralLedgerModels.Analysis();
                    analysis.AnalysisId = Convert.ToInt32(accountingAccountEntity.AnalysisId);

                    accountingAccounts.Add(new GeneralLedgerModels.AccountingAccount
                    {
                        AccountingAccountId = accountingAccountEntity.AccountingAccountId,
                        Number = accountingAccountEntity.AccountNumber,
                        Description = accountingAccountEntity.AccountName,
                        Branch = branch,
                        Currency = currency,
                        AccountingNature = (GeneralLedgerModels.AccountingNatures)accountingAccountEntity.AccountingNature
                    });
                }

                filteredAccountingAccounts = accountingAccounts.Count > 10 ? accountingAccounts.GetRange(0, 10) : accountingAccounts;
            }
            catch
            {
                filteredAccountingAccounts = new List<GeneralLedgerModels.AccountingAccount>();
            }

            return filteredAccountingAccounts;
        }

        /// <summary>
        /// HasChildren
        /// Verifica si la cuenta contable tiene cuentas hijas
        /// </summary>
        /// <param name="accountingAccountId"></param>
        /// <returns>bool</returns>
        public bool HasChildren(int accountingAccountId)
        {
            bool isChildren = false;

            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(AccountingAccount.Properties.AccountingAccountParentId, accountingAccountId);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(Entities.AccountingAccount), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    isChildren = true;
                }
            }
            catch
            {
                isChildren = false;
            }

            return isChildren;
        }

        /// <summary>
        /// OnEntry
        /// Función que comprueba que la cuenta no está siendo usada en asientos de diario o de mayor
        /// </summary>
        /// <param name="accountingAccountId"></param>
        /// <returns>bool</returns>
        public bool OnEntry(int accountingAccountId)
        {
            bool isEntry = false;

            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(JournalEntryItem.Properties.AccountingAccountId, accountingAccountId);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(JournalEntryItem), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    isEntry = true;
                }
                else
                {
                    criteriaBuilder = new ObjectCriteriaBuilder();
                    criteriaBuilder.PropertyEquals(Entry.Properties.AccountingAccountId, accountingAccountId);
                    BusinessCollection businessCollectionEntry = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(Entry), criteriaBuilder.GetPredicate()));

                    if (businessCollectionEntry.Count > 0)
                    {
                        isEntry = true;
                    }
                }
            }
            catch
            {
                isEntry = false;
            }

            return isEntry;
        }

        /// <summary>
        /// ValidateAccountingAccount
        /// Método para validar número de Cuenta
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <param name="edit"></param>
        /// <returns>AccountingAccountValidationDTO</returns>
        public AccountingAccountValidationDTO ValidateAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount, int edit)
        {
            AccountingAccountValidationDTO validationDTO = new AccountingAccountValidationDTO { IsSucessful = false, TypeId = 100 };
            accountingAccount.Description = String.Empty;
            var lengthLevel = 0;

            if (edit == 0)
            {
                validationDTO = ValidateAccountingAccountNumberDoesNotExist(accountingAccount.Number);

                if (!validationDTO.IsSucessful)
                {
                    return validationDTO;
                }
                else
                {
                    // Compruebo que la cuenta exista, quitándole los ceros.
                    AccoutingAccountLevelDTO accountLevelDTO = GetAccountingAccountLevel(accountingAccount);
                    accountingAccount.Number = accountingAccount.Number.Substring(0, accountLevelDTO.Length);
                    lengthLevel = accountLevelDTO.Length;
                }
            }
            if (edit == 1)
            {
                try
                {
                    AccoutingAccountLevelDTO accountLevelDTO = GetAccountingAccountLevel(accountingAccount);
                    accountingAccount.Number = accountingAccount.Number.Substring(0, accountLevelDTO.Length);
                    lengthLevel = accountLevelDTO.Length;
                }
                catch (BusinessException)
                {
                    validationDTO.IsSucessful = false;
                }
            }

            try
            {
                GeneralLedgerModels.AccountingAccount parentAccount;

                // Obtengo el nivel y longitud de la cuenta padre
                if (accountingAccount.AccountingAccountParentId >= 10)
                {
                    parentAccount = GetAccountingAccount(accountingAccount.AccountingAccountParentId);

                    //se elimina los datos de sucursal y ramo en el número de cuenta padre para realizar la validación
                    parentAccount = AssembleParentAccountForValidation(parentAccount);
                }
                else
                {
                    parentAccount = GetAccountingAccountParent(accountingAccount.AccountingAccountParentId);
                }

                AccoutingAccountLevelDTO accountingAccountLevelParent = GetAccountingAccountLevel(parentAccount);
                AccoutingAccountLevelDTO accountingAccountLevel = GetAccountingAccountLevel(accountingAccount);

                validationDTO = ValidateAccountingAccountBaseNumber(accountingAccount, accountingAccountLevelParent, accountingAccountLevel, lengthLevel);

                if (validationDTO.IsSucessful)
                {
                    string accountParentNumber = "";
                    string accountNumber = "";

                    accountParentNumber = parentAccount.Number.Substring(0, accountingAccountLevelParent.Length);
                    accountNumber = accountingAccount.Number.Substring(0, accountingAccountLevelParent.Length);

                    if (accountParentNumber.Trim() != accountNumber.Trim())
                    {
                        validationDTO.TypeId = 2;
                        validationDTO.IsSucessful = false;
                    }
                }
            }
            catch (BusinessException)
            {
                validationDTO.IsSucessful = false;
                validationDTO.TypeId = 5; // No existe cuenta Padre
            }

            return validationDTO;
        }

        /// <summary>
        /// GetAccountingAccountsByParentId
        /// </summary>
        /// <param name="accountParentId"></param>
        /// <returns>List<GeneralLedgerModels.AccountingAccount></returns>
        public List<GeneralLedgerModels.AccountingAccount> GetAccountingAccountsByParentId(int accountParentId)
        {
            List<GeneralLedgerModels.AccountingAccount> accountingAccounts = new List<GeneralLedgerModels.AccountingAccount>();

            try
            {
                AccountingAccountDAO accountingAccountDAO = new AccountingAccountDAO();
                ObjectCriteriaBuilder filter = new ObjectCriteriaBuilder();
                filter.PropertyEquals(Entities.AccountingAccount.Properties.AccountingAccountParentId, accountParentId);

                BusinessCollection accountsCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AccountingAccount), filter.GetPredicate()));

                if (accountsCollection.Count > 0)
                {
                    foreach (Entities.AccountingAccount accountingAccountEntity in accountsCollection.OfType<AccountingAccount>())
                    {
                        GeneralLedgerModels.AccountingAccount accountingAccount = accountingAccountDAO.GetAccountingAccount(accountingAccountEntity.AccountingAccountId);
                        accountingAccounts.Add(accountingAccount);
                    }
                }
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return accountingAccounts;
        }

        #endregion AccountingAccount

        #region AccountingAccountParent

        /// <summary>
        /// GetAccountingAccountParent
        /// Obtiene cuenta contable principal
        /// </summary>
        /// <param name="accountingAccountId"></param>
        /// <returns>AccountingAccount</returns>
        public GeneralLedgerModels.AccountingAccount GetAccountingAccountParent(int accountingAccountId)
        {
            try
            {
                AccountingAccountParentDAO accountingAccountParentDAO = new AccountingAccountParentDAO();
                return accountingAccountParentDAO.GetAccountingAccountParent(accountingAccountId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAccountingAccountParents
        /// Obtiene Listado de cuentas contables principales
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingAccount></returns>
        public List<GeneralLedgerModels.AccountingAccount> GetAccountingAccountParents()
        {
            try
            {
                AccountingAccountParentDAO accountingAccountParentDAO = new AccountingAccountParentDAO();
                return accountingAccountParentDAO.GetAccountingAccountParents();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion AccountingAccountParent

        #region LedgerEntry

        /// <summary>
        /// SaveLedgerEntry
        /// </summary>
        /// <param name="ledgerEntry"></param>
        /// <returns>int</returns>
        public int SaveLedgerEntry(GeneralLedgerModels.LedgerEntry ledgerEntry)
        {
            LedgerEntryDAO ledgerEntryDAO = new LedgerEntryDAO();
            return ledgerEntryDAO.SaveLedgerEntryTransaction(ledgerEntry, false).EntryNumber;
        }

        /// <summary>
        /// ReverseLedgerEntry
        /// </summary>
        /// <param name="ledgerEntry"></param>
        /// <returns>int</returns>
        public int ReverseLedgerEntry(GeneralLedgerModels.LedgerEntry ledgerEntry)
        {
            try
            {
                EntryRevertionDAO entryRevertionDAO = new EntryRevertionDAO();
                LedgerEntryDAO ledgerEntryDAO = new LedgerEntryDAO();
                //Se obtiene el asiento por clave primaria
                GeneralLedgerModels.LedgerEntry newLedgerEntry = ledgerEntryDAO.GetLedgerEntryById(ledgerEntry.Id);
                newLedgerEntry.Id = 0; //es un nuevo registro
                newLedgerEntry.AccountingDate = ledgerEntry.AccountingDate;
                newLedgerEntry.RegisterDate = DateTime.Now;
                newLedgerEntry.Description = "REVERSION DEL ASIENTO # " + ledgerEntry.EntryNumber;

                //Se cambia la naturaleza de los movimientos.
                if (newLedgerEntry.LedgerEntryItems.Count > 0)
                {
                    foreach (GeneralLedgerModels.LedgerEntryItem ledgerEntryItem in newLedgerEntry.LedgerEntryItems)
                    {
                        ledgerEntryItem.AccountingNature = ledgerEntryItem.AccountingNature == GeneralLedgerModels.AccountingNatures.Credit ? GeneralLedgerModels.AccountingNatures.Debit : GeneralLedgerModels.AccountingNatures.Credit;
                    }
                }

                //se graba el nuevo asiento
                newLedgerEntry = ledgerEntryDAO.SaveLedgerEntryTransaction(newLedgerEntry, false);

                //se graba la relación del asiento de origen y destino
                entryRevertionDAO.SaveEntryRevertion(0, ledgerEntry.Id, newLedgerEntry.Id, ledgerEntry.UserId, DateTime.Now, false);

                return newLedgerEntry.EntryNumber;
            }
            catch (BusinessException ex)
            {
                if (ex.Message.Contains("BusinessException"))
                {
                    throw new BusinessException(ConfigurationManager.AppSettings["BusinessExceptionMsj"]);
                }

                throw new BusinessException(ConfigurationManager.AppSettings["UnhandledExceptionMsj"]);
            }
        }

        /// <summary>
        /// GetLedgerEntries
        /// </summary>
        /// <param name="ledgerEntryId"></param>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="branchId"></param>
        /// <param name="destinationId"></param>
        /// <param name="accountingMovementTypeId"></param>
        /// <returns>List<LedgerEntry/></returns>
        public List<GeneralLedgerModels.LedgerEntry> GetLedgerEntries(int ledgerEntryId, DateTime dateFrom, DateTime dateTo, int branchId, int destinationId, int accountingMovementTypeId)
        {
            LedgerEntryDAO ledgerEntryDAO = new LedgerEntryDAO();
            return ledgerEntryDAO.GetLedgerEntries(ledgerEntryId, dateFrom, dateTo, branchId, destinationId, accountingMovementTypeId);
        }

        #endregion LedgerEntry

        #region EntryConsultation

        /// <summary>
        /// SearchEntryMovements
        /// Busca asientos de mayor
        /// </summary>
        /// <param name="entryNumber"></param>
        /// <param name="startDate"></param>
        /// <param name="endDate"></param>
        /// <param name="branchId"></param>
        /// <param name="destinationId"></param>
        /// <param name="accountingMovementTypeId"></param>
        /// <returns>List<EntryConsultationDTO/></returns>
        public List<EntryConsultationDTO> SearchEntryMovements(int entryNumber, DateTime startDate, DateTime endDate, int branchId, int destinationId, int accountingMovementTypeId)
        {
            try
            {
                int rows;
                var entryConsultationDTOs = new List<EntryConsultationDTO>();
                var criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(Entry.Properties.EntryNumber, entryNumber);
                criteriaBuilder.And();
                criteriaBuilder.Property(Entry.Properties.Date);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(startDate);
                criteriaBuilder.And();
                criteriaBuilder.Property(Entry.Properties.Date);
                criteriaBuilder.LessEqual();
                criteriaBuilder.Constant(endDate);

                if (branchId > 0)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(Entry.Properties.BranchCode, branchId);
                }
                if (destinationId > 0)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(Entry.Properties.EntryDestinationId, destinationId);
                }
                if (accountingMovementTypeId > 0)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(Entry.Properties.AccountingMovementTypeId, accountingMovementTypeId);
                }

                UIView entryConsultation = _dataFacadeManager.GetDataFacade().GetView("EntryConsultation", criteriaBuilder.GetPredicate(), null, 0, 100, null, true, out rows);

                if (entryConsultation.Count > 0)
                {
                    entryConsultationDTOs = (from DataRow dataRow in entryConsultation.Rows
                                             select new EntryConsultationDTO()
                                             {
                                                 EntryId = Convert.ToInt32(dataRow["EntryId"].ToString()),
                                                 AccountingAccountId = Convert.ToInt32(dataRow["AccountingAccountId"].ToString()),
                                                 AccountingAccountNumber = dataRow["AccountNumber"].ToString(),
                                                 AccountingAccountName = Convert.ToString(dataRow["AccountName"]),
                                                 CurrencyId = Convert.ToInt32(dataRow["CurrencyCode"].ToString()),
                                                 CurrencyDescription = "",
                                                 AccountingNature = Convert.ToInt32(dataRow["AccountingNature"].ToString()),
                                                 DebitsAmountValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Debit ? Convert.ToDecimal(dataRow["AmountValue"].ToString()) : 0,
                                                 DebitsAmountLocalValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Debit ? Convert.ToDecimal(dataRow["AmountLocalValue"].ToString()) : 0,
                                                 CreditsAmountValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Credit ? Convert.ToDecimal(dataRow["AmountValue"].ToString()) : 0,
                                                 CreditsAmountLocalValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Credit ? Convert.ToDecimal(dataRow["AmountLocalValue"].ToString()) : 0,
                                                 Date = String.Format("{0:dd/MM/yyyy}", dataRow["Date"].ToString()),
                                                 EntryDescription = dataRow["EntryDescription"].ToString(),
                                                 EntryNumber = Convert.ToInt32(dataRow["EntryNumber"].ToString()),
                                                 BranchId = Convert.ToInt32(dataRow["BranchCode"].ToString()),
                                                 BranchDescription = "",
                                                 UserId = Convert.ToInt32(dataRow["UserCode"].ToString()),
                                                 UserName = "",
                                                 Status = GetEntryStatus(Convert.ToInt32(dataRow["EntryId"].ToString()), false),
                                                 EntryDestinationId = Convert.ToInt32(dataRow["EntryDestinationId"].ToString()),
                                                 EntryDestinationDescription = dataRow["EntryDestinationDescription"].ToString(),
                                                 AccountingMovementTypeId = Convert.ToInt32(dataRow["AccountingMovementTypeId"].ToString()),
                                                 AccountingMovementTypeDescription = dataRow["AccountingMovementTypeDescription"].ToString()
                                             }).ToList();
                }

                return entryConsultationDTOs;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// SearchDailyEntryMovements
        /// Busca asientos de diario
        /// </summary>
        /// <param name="entryNumber"></param>
        /// <param name="startDate"></param>
        /// <param name="endDate"></param>
        /// <param name="branchId"></param>
        /// <param name="destinationId"></param>
        /// <param name="accountingMovementTypeId"></param>
        /// <returns>List<EntryConsultationDTO/></returns>
        public List<EntryConsultationDTO> SearchDailyEntryMovements(int entryNumber, DateTime startDate, DateTime endDate, int branchId, int destinationId, int accountingMovementTypeId)
        {
            try
            {
                int rows;
                var entryConsultationDTOs = new List<EntryConsultationDTO>();
                var criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(JournalEntryItem.Properties.JournalEntryId, entryNumber);

                if (branchId > 0)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(JournalEntry.Properties.BranchCode, branchId);
                }

                if (startDate != Convert.ToDateTime("01/01/1900"))
                {
                    criteriaBuilder.And();
                    criteriaBuilder.Property(JournalEntry.Properties.Date);
                    criteriaBuilder.GreaterEqual();
                    criteriaBuilder.Constant(startDate);
                }

                if (endDate != Convert.ToDateTime("01/01/1900"))
                {
                    criteriaBuilder.And();
                    criteriaBuilder.Property(JournalEntry.Properties.Date);
                    criteriaBuilder.LessEqual();
                    criteriaBuilder.Constant(endDate);
                }

                var entryConsultation = _dataFacadeManager.GetDataFacade().GetView("DailyEntryConsultation", criteriaBuilder.GetPredicate(), null, 0, 10000, null, true, out rows);

                if (entryConsultation.Count > 0)
                {
                    entryConsultationDTOs = (from DataRow dataRow in entryConsultation.Rows
                                             select new EntryConsultationDTO()
                                             {
                                                 EntryId = Convert.ToInt32(dataRow["JournalEntryItemId"].ToString()),
                                                 AccountingAccountId = Convert.ToInt32(dataRow["AccountingAccountId"].ToString()),
                                                 AccountingAccountNumber = dataRow["AccountNumber"].ToString(),
                                                 AccountingAccountName = dataRow["AccountName"].ToString(),
                                                 CurrencyId = Convert.ToInt32(dataRow["CurrencyCode"].ToString()),
                                                 CurrencyDescription = "",
                                                 AccountingNature = Convert.ToInt32(dataRow["AccountingNature"].ToString()),
                                                 DebitsAmountValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Debit ? Convert.ToDecimal(dataRow["AmountValue"].ToString()) : 0,
                                                 DebitsAmountLocalValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Debit ? Convert.ToDecimal(dataRow["AmountLocalValue"].ToString()) : 0,
                                                 CreditsAmountValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Credit ? Convert.ToDecimal(dataRow["AmountValue"].ToString()) : 0,
                                                 CreditsAmountLocalValue = (GeneralLedgerModels.AccountingNatures)Convert.ToInt32(dataRow["AccountingNature"].ToString()) == GeneralLedgerModels.AccountingNatures.Credit ? Convert.ToDecimal(dataRow["AmountLocalValue"].ToString()) : 0,
                                                 EntryHeaderDescription = dataRow["EntryHeaderDescription"].ToString(),
                                                 Date = Convert.ToDateTime(dataRow["Date"].ToString()).ToString("dd/MM/yyyy"),
                                                 EntryDescription = dataRow["Description"].ToString(),
                                                 EntryNumber = Convert.ToInt32(dataRow["EntryNumber"].ToString()),
                                                 BranchId = Convert.ToInt32(dataRow["BranchCode"].ToString()),
                                                 BranchDescription = "",
                                                 UserId = Convert.ToInt32(dataRow["UserCode"].ToString()),
                                                 UserName = "",
                                                 DailyEntryHeaderId = Convert.ToInt32(dataRow["JournalEntryId"].ToString()),
                                                 Status = GetEntryStatus(Convert.ToInt32(dataRow["JournalEntryId"].ToString()), true)
                                             }).ToList();
                }

                return entryConsultationDTOs;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetCostCentersByEntryId
        /// Obtiene centros de costo por Id de asiento
        /// </summary>
        /// <param name="entryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.CostCenter></returns>
        public List<GeneralLedgerModels.CostCenter> GetCostCentersByEntryId(int entryItemId, bool isJournalEntry)
        {
            List<GeneralLedgerModels.CostCenter> costCenters = new List<GeneralLedgerModels.CostCenter>();

            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(CostCenterEntryItem.Properties.EntryItemId, entryItemId);
                criteriaBuilder.And();
                criteriaBuilder.PropertyEquals(CostCenterEntryItem.Properties.IsJournalEntry, isJournalEntry);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(CostCenterEntryItem), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    foreach (CostCenterEntryItem costCenterEntryItemEntity in businessCollection.OfType<CostCenterEntryItem>())
                    {
                        GeneralLedgerModels.CostCenter costCenter = new GeneralLedgerModels.CostCenter();
                        costCenter.CostCenterId = Convert.ToInt32(costCenterEntryItemEntity.CostCenterId);
                        costCenter = GetCostCenter(costCenter);
                        costCenter.PercentageAmount = Convert.ToDecimal(costCenterEntryItemEntity.CostCenterPercentage);
                        costCenters.Add(costCenter);
                    }
                }

                return costCenters;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetEntryAnalysesByEntryId
        /// Obtiene análisis por Id de asiento
        /// </summary>
        /// <param name="entryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<EntryAnalysisDTO></returns>
        public List<EntryAnalysisDTO> GetEntryAnalysesByEntryId(int entryItemId, bool isJournalEntry)
        {
            List<EntryAnalysisDTO> entryAnalysisDTOs = new List<EntryAnalysisDTO>();

            try
            {
                int rows;
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(AnalysisEntryItem.Properties.EntryItemId, entryItemId);
                criteriaBuilder.And();
                criteriaBuilder.PropertyEquals(AnalysisEntryItem.Properties.IsJournalEntry, isJournalEntry);

                UIView analysisEntries = _dataFacadeManager.GetDataFacade().GetView("GetAnalysisByEntry", criteriaBuilder.GetPredicate(), null, 0, 50, null, true, out rows);

                if (analysisEntries.Count > 0)
                {
                    foreach (DataRow data in analysisEntries)
                    {
                        entryAnalysisDTOs.Add(new EntryAnalysisDTO
                        {
                            EntryAnalysisId = Convert.ToInt32(data["AnalysisEntryItemId"]),
                            AnalysisId = Convert.ToInt32(data["AnalysisId"]),
                            AnalysisDescription = Convert.ToString(data["AnalysisDescription"]),
                            AnalysisConceptId = Convert.ToInt32(data["AnalysisConceptId"]),
                            AnalysisConceptDescription = Convert.ToString(data["AnalysisConceptDescription"]),
                            EntryId = Convert.ToInt32(data["EntryItemId"]),
                            ConceptKey = Convert.ToString(data["ConceptKey"]),
                            EntryAnalysisDescription = Convert.ToString(data["EntryAnalysisDescription"])
                        });
                    }
                }

                return entryAnalysisDTOs;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetPostdatedByEntryId
        /// Obtiene postfechados por Id de asiento
        /// </summary>
        /// <param name="entryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.PostDated></returns>
        public List<GeneralLedgerModels.PostDated> GetPostdatedByEntryId(int entryItemId, bool isJournalEntry)
        {
            List<GeneralLedgerModels.PostDated> postdated = new List<GeneralLedgerModels.PostDated>();
            PostDatedDAO postDatedDAO = new PostDatedDAO();
            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

                criteriaBuilder.PropertyEquals(PostdatedEntryItem.Properties.EntryItemId, entryItemId);
                criteriaBuilder.And();
                criteriaBuilder.PropertyEquals(PostdatedEntryItem.Properties.IsJournalEntry, isJournalEntry);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(PostdatedEntryItem), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    foreach (PostdatedEntryItem postdatedEntryItemEntity in businessCollection.OfType<PostdatedEntryItem>())
                    {
                        GeneralLedgerModels.PostDated postDated = postDatedDAO.GetPostDated(postdatedEntryItemEntity.PostdatedEntryItemId);
                        postdated.Add(postDated);
                    }
                }
                return postdated;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetEntryStatus
        /// Obtiene el estado de un movimiento
        /// </summary>
        /// <param name="entryId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>AccountingEntryStatus</returns>
        public AccountingEntryStatus GetEntryStatus(int entryId, bool isJournalEntry)
        {
            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

            criteriaBuilder.PropertyEquals(EntryRevertion.Properties.EntrySourceId, entryId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(EntryRevertion.Properties.IsJournalEntry, isJournalEntry);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(EntryRevertion), criteriaBuilder.GetPredicate()));

            return businessCollection.Count > 0 ? AccountingEntryStatus.Reverted : AccountingEntryStatus.Active;
        }

        /// <summary>
        /// GetJournalEntry
        /// </summary>
        /// <param name="journalEntry"></param>
        /// <returns>JournalEntry</returns>
        public GeneralLedgerModels.JournalEntry GetJournalEntry(GeneralLedgerModels.JournalEntry journalEntry)
        {
            try
            {
                JournalEntryItemDAO journalEntryItemDAO = new JournalEntryItemDAO();
                JournalEntryDAO journalEntryDAO = new JournalEntryDAO();
                journalEntry = journalEntryDAO.GetJournalEntry(journalEntry);
                journalEntry.JournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();

                ObjectCriteriaBuilder filter = new ObjectCriteriaBuilder();
                filter.PropertyEquals(JournalEntryItem.Properties.JournalEntryId, journalEntry.Id);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(JournalEntryItem), filter.GetPredicate()));
                //se llena los movimientos del asiento de diario
                if (businessCollection.Any())
                {
                    foreach (JournalEntryItem journalEntryItemEntity in businessCollection.OfType<JournalEntryItem>())
                    {
                        GeneralLedgerModels.JournalEntryItem journalEntryItem = new GeneralLedgerModels.JournalEntryItem();
                        journalEntryItem.Id = journalEntryItemEntity.JournalEntryItemId;
                        journalEntryItem = journalEntryItemDAO.GetJournalEntryItem(journalEntryItem);
                        journalEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        journalEntryItem.CostCenters = GetCostCentersByEntryId(journalEntryItemEntity.JournalEntryItemId, true);
                        journalEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        journalEntryItem.Analysis = GetAnalysesByEntryId(journalEntryItemEntity.JournalEntryItemId, true);
                        journalEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        journalEntryItem.CostCenters = GetCostCentersByEntryId(journalEntryItemEntity.JournalEntryItemId, true);

                        journalEntry.JournalEntryItems.Add(journalEntryItem);
                    }
                }
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return journalEntry;
        }

        #endregion EntryConsultation

        #region JournalEntry

        /// <summary>
        /// SaveJournalEntry
        /// </summary>
        /// <param name="journalEntry"></param>
        /// <returns>int</returns>
        public int SaveJournalEntry(GeneralLedgerModels.JournalEntry journalEntry)
        {
            CommonModels.Parameter journalEntryParameter = DelegateService.commonService.GetParameterByParameterId(Convert.ToInt32(ConfigurationManager.AppSettings["JournalEntryTransactionNumber"]));

            int journalEntryNumber = Convert.ToInt32(journalEntryParameter.NumberParameter);
            int journalEntryId = 0;

            try
            {
                JournalEntryDAO journalEntryDAO = new JournalEntryDAO();
                JournalEntryItemDAO journalEntryItemDAO = new JournalEntryItemDAO();
                //se graba la cabecera del asiento.
                journalEntry.EntryNumber = journalEntryNumber;
                GeneralLedgerModels.JournalEntry newJournalEntry = journalEntryDAO.SaveJournalEntry(journalEntry);

                //si se graba la cabecera, se procede a grabar los movimientos.
                if (newJournalEntry.Id > 0)
                {
                    if (journalEntry.JournalEntryItems.Any())
                    {
                        foreach (GeneralLedgerModels.JournalEntryItem journalEntryItem in journalEntry.JournalEntryItems)
                        {
                            GeneralLedgerModels.JournalEntryItem newJournalEntryItem = journalEntryItemDAO.SaveJournalEntryItem(journalEntryItem, newJournalEntry.Id);
                            SaveItemGroup(journalEntryItem, newJournalEntryItem);
                        }

                        journalEntryId = newJournalEntry.Id;

                        if (journalEntryId > 0)
                        {
                            //se actualiza el número de asiento
                            journalEntryParameter.NumberParameter = journalEntryNumber + 1;
                            DelegateService.commonService.UpdateParameter(journalEntryParameter);
                        }
                    }
                    else
                    {
                        //Si no existen items en el asiento elimina la cabecera y envía el código de mensaje de error de grabación de asiento.
                        journalEntryDAO.DeleteJournalEntry(journalEntry);
                        journalEntryId = -2;
                    }

                }
            }
            catch (BusinessException exception)
            {
                var message = exception.Message; //mensaje para revisión de errores
                journalEntryId = 0;
            }

            return journalEntryId;
        }

        /// <summary>
        /// ReverseJournalEntry
        /// </summary>
        /// <param name="journalEntry"></param>
        /// <returns>int</returns>
        public int ReverseJournalEntry(GeneralLedgerModels.JournalEntry journalEntry)
        {
            int newJournalEntryId = 0;

            try
            {
                EntryRevertionDAO entryRevertionDAO = new EntryRevertionDAO();
                JournalEntryDAO journalEntryDAO = new JournalEntryDAO();
                //se actualiza el asiento de origen.
                journalEntry = journalEntryDAO.GetJournalEntry(journalEntry);
                journalEntry.Status = Convert.ToInt32(AccountingEntryStatus.Reverted);
                journalEntry = journalEntryDAO.UpdateJournalEntry(journalEntry);

                //se obtiene la cabecera del asiento.
                GeneralLedgerModels.JournalEntry newJournalEntry = journalEntryDAO.GetJournalEntry(journalEntry);
                newJournalEntry.Id = 0; //se resetea el id para el nuevo asiento
                newJournalEntry.EntryNumber = journalEntry.EntryNumber;
                newJournalEntry.RegisterDate = DateTime.Now;
                newJournalEntry.AccountingDate = journalEntry.AccountingDate;

                //se obtienen los movimientos del asiento.
                newJournalEntry.JournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();

                newJournalEntry.JournalEntryItems = SetRevertionJournalEntryItems(journalEntry.Id);

                newJournalEntry.Description = "REVERSION DEL ASIENTO # " + journalEntry.Id;
                newJournalEntry.Status = Convert.ToInt32(AccountingEntryStatus.Active);
                newJournalEntryId = SaveJournalEntry(newJournalEntry);

                //se graba la relación del asiento de origen y destino.
                entryRevertionDAO.SaveEntryRevertion(0, journalEntry.Id, newJournalEntryId, journalEntry.UserId, DateTime.Now, true);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return newJournalEntryId;
        }

        /// <summary>
        /// GetJournalEntries
        /// </summary>
        /// <param name="journalEntryId"></param>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="branchId"></param>
        /// <returns>List<GeneralLedgerModels.JournalEntry></returns>
        public List<GeneralLedgerModels.JournalEntry> GetJournalEntries(int journalEntryId, DateTime dateFrom, DateTime dateTo, int branchId)
        {
            return new List<GeneralLedgerModels.JournalEntry>();
        }

        #endregion JournalEntry

        #region CostCenterEntry

        /// <summary>
        /// SaveCostCenterEntry
        /// Graba Centros de costos asociados a un movimiento de Asiento de diario o de mayor
        /// </summary>
        /// <param name="costCenter"></param>
        /// <param name="accountingEntry"></param>
        /// <param name="isDailyEntry"></param>
        public void SaveCostCenterEntry(GeneralLedgerModels.CostCenter costCenter, GeneralLedgerModels.JournalEntry accountingEntry, bool isDailyEntry)
        {
            CostCenterEntryDAO costCenterEntryDAO = new CostCenterEntryDAO();
            costCenterEntryDAO.SaveCostCenterEntry(costCenter, accountingEntry.Id, isDailyEntry);
        }

        #endregion CostCenterEntry

        #endregion GL

        #region PARAM

        #region AccountingCompany

        /// <summary>
        /// SaveAccountingCompany
        /// Graba una compania
        /// </summary>
        /// <param name="accountingCompany"></param>
        /// <returns>AccountingCompany</returns>
        public GeneralLedgerModels.AccountingCompany SaveAccountingCompany(GeneralLedgerModels.AccountingCompany accountingCompany)
        {
            try
            {
                AccountingCompanyDAO accountingCompanyDAO = new AccountingCompanyDAO();
                accountingCompany = accountingCompanyDAO.SaveAccountingCompany(accountingCompany);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingCompany;
        }

        /// <summary>
        /// UpdateAccountingCompany
        /// Actualiza compañía
        /// </summary>
        /// <param name="accountingCompany"></param>
        /// <returns>AccountingCompany</returns>
        public GeneralLedgerModels.AccountingCompany UpdateAccountingCompany(GeneralLedgerModels.AccountingCompany accountingCompany)
        {
            try
            {
                AccountingCompanyDAO accountingCompanyDAO = new AccountingCompanyDAO();
                accountingCompany = accountingCompanyDAO.UpdateAccountingCompany(accountingCompany);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingCompany;
        }

        /// <summary>
        /// DeleteAccountingCompany
        /// Borra compañía
        /// </summary>
        /// <param name="accountingCompanyId"></param>
        /// <returns>bool</returns>
        public bool DeleteAccountingCompany(int accountingCompanyId)
        {
            AccountingCompanyDAO accountingCompanyDAO = new AccountingCompanyDAO();

            bool isDeleted;

            try
            {
                isDeleted = accountingCompanyDAO.DeleteAccountingCompany(accountingCompanyId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return isDeleted;
        }

        /// <summary>
        /// GetAccountingCompany
        /// Obtiene compañía
        /// </summary>
        /// <param name="accountingCompany"></param>
        /// <returns>AccountingCompany</returns>
        public GeneralLedgerModels.AccountingCompany GetAccountingCompany(GeneralLedgerModels.AccountingCompany accountingCompany)
        {
            try
            {
                AccountingCompanyDAO accountingCompanyDAO = new AccountingCompanyDAO();
                return accountingCompanyDAO.GetAccountingCompany(accountingCompany);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAccountingCompanies
        /// Obtiene el listado de compañías
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingCompany></returns>
        public List<GeneralLedgerModels.AccountingCompany> GetAccountingCompanies()
        {
            try
            {
                AccountingCompanyDAO accountingCompanyDAO = new AccountingCompanyDAO();
                return accountingCompanyDAO.GetAccountingCompanies();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// VerifyCompanyUsed
        /// Verifica si una compañía de la tabla esta siendo usada por un movimiento Contable
        /// </summary>
        /// <param name="companyId"></param>
        /// <returns>bool</returns>
        public bool VerifyCompanyUsed(int companyId)
        {
            try
            {
                // Creación del  filtro 
                var criteriaBuilder = new ObjectCriteriaBuilder();
                if (companyId != 0)
                {
                    criteriaBuilder.Property(JournalEntry.Properties.AccountingCompanyId);
                    criteriaBuilder.Equal();
                    criteriaBuilder.Constant(companyId);
                }

                // Asignamos BusinessCollection a una Lista
                var businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(JournalEntry),
                                                                        criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    return true;
                }
                else
                {
                    criteriaBuilder = new ObjectCriteriaBuilder();
                    if (companyId != 0)
                    {
                        criteriaBuilder.Property(LedgerEntry.Properties.AccountingCompanyId);
                        criteriaBuilder.Equal();
                        criteriaBuilder.Constant(companyId);
                    }

                    // Asignamos BusinessCollection a una Lista
                    businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(LedgerEntry),
                                                                criteriaBuilder.GetPredicate()));

                    if (businessCollection.Count > 0)
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion AccountingCompany

        #region AccountingMovementType

        /// <summary>
        /// GetAccountingMovementType
        /// Obtiene Tipo de movimiento contable
        /// </summary>
        /// <param name="accountingMovementType"></param>
        /// <returns>AccountingMovementType</returns>
        public GeneralLedgerModels.AccountingMovementType GetAccountingMovementType(GeneralLedgerModels.AccountingMovementType accountingMovementType)
        {
            AccountingMovementTypeDAO accountingMovementTypeDAO = new AccountingMovementTypeDAO();
            return accountingMovementTypeDAO.GetAccountingMovementType(accountingMovementType);
        }

        /// <summary>
        /// GetAccountingMovementTypes
        /// Obtiene listado de tipos de movimientos contables
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingMovementType></returns>
        public List<GeneralLedgerModels.AccountingMovementType> GetAccountingMovementTypes()
        {
            AccountingMovementTypeDAO accountingMovementTypeDAO = new AccountingMovementTypeDAO();
            return accountingMovementTypeDAO.GetAccountingMovementTypes();
        }

        /// <summary>
        /// GetManualAccountingMovementTypes
        /// Obtiene Tipo de movimiento contable manuales
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AccountingMovementType></returns>
        public List<GeneralLedgerModels.AccountingMovementType> GetManualAccountingMovementTypes()
        {
            List<GeneralLedgerModels.AccountingMovementType> accountingMovementTypes = new List<GeneralLedgerModels.AccountingMovementType>();

            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

            // Se obtiene los movimientos manuales
            criteriaBuilder.Property(AccountingMovementType.Properties.IsAutomatic);
            criteriaBuilder.Equal();
            criteriaBuilder.Constant(0);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AccountingMovementType), criteriaBuilder.GetPredicate()));

            if (businessCollection.Count > 0)
            {
                foreach (AccountingMovementType accountingMovementTypeEntity in businessCollection.OfType<AccountingMovementType>())
                {
                    GeneralLedgerModels.AccountingMovementType accountingMovementType = new GeneralLedgerModels.AccountingMovementType();
                    accountingMovementType.AccountingMovementTypeId = accountingMovementTypeEntity.AccountingMovementTypeId;
                    accountingMovementType.Description = accountingMovementTypeEntity.Description;
                    accountingMovementType.IsAutomatic = Convert.ToBoolean(accountingMovementTypeEntity.IsAutomatic);
                    accountingMovementTypes.Add(accountingMovementType);
                }
            }
            return accountingMovementTypes;
        }

        #endregion AccountingMovementType

        #region Analysis

        /// <summary>
        /// GetAnalysis
        /// Obtiene Analisis
        /// </summary>
        /// <param name="analysisId"></param>
        /// <returns>Analysis</returns>
        public GeneralLedgerModels.Analysis GetAnalysis(int analysisId)
        {
            AnalysisDAO analysisDAO = new AnalysisDAO();
            return analysisDAO.GetAnalysis(analysisId);
        }

        /// <summary>
        /// GetAnalyses
        /// Obtiene listado de Analisis
        /// </summary>
        /// <returns>List<GeneralLedgerModels.Analysis></returns>
        public List<GeneralLedgerModels.Analysis> GetAnalyses()
        {
            AnalysisDAO analysisDAO = new AnalysisDAO();
            return analysisDAO.GetAnalyses();
        }

        #endregion Analysis

        #region AnalysisCode

        /// <summary>
        /// SaveAnalysisCode
        /// </summary>
        /// <param name="analysisCode"></param>
        /// <returns>AnalysisCode</returns>
        public GeneralLedgerModels.AnalysisCode SaveAnalysisCode(GeneralLedgerModels.AnalysisCode analysisCode)
        {
            try
            {
                AnalysisCodeDAO analysisCodeDAO = new AnalysisCodeDAO();
                analysisCode = analysisCodeDAO.SaveAnalysisCode(analysisCode);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisCode;
        }

        /// <summary>
        /// UpdateAnalysisCode
        /// Actualiza Código de Analisis
        /// </summary>
        /// <param name="analysisCode"></param>
        /// <returns>AnalysisCode</returns>
        public GeneralLedgerModels.AnalysisCode UpdateAnalysisCode(GeneralLedgerModels.AnalysisCode analysisCode)
        {
            try
            {
                AnalysisCodeDAO analysisCodeDAO = new AnalysisCodeDAO();
                analysisCode = analysisCodeDAO.UpdateAnalysisCode(analysisCode);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisCode;
        }

        /// <summary>
        /// DeleteAnalysisCode
        /// Borra Código de Analisis
        /// </summary>
        /// <param name="analysisId"></param>
        public void DeleteAnalysisCode(int analysisId)
        {
            try
            {
                AnalysisCodeDAO analysisCodeDAO = new AnalysisCodeDAO();
                analysisCodeDAO.DeleteAnalysisCode(analysisId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAnalysisCode
        /// Obtiene Código de Analisis
        /// </summary>
        /// <param name="analysisCodeId"></param>
        /// <returns>AnalysisCode</returns>
        public GeneralLedgerModels.AnalysisCode GetAnalysisCode(int analysisCodeId)
        {
            AnalysisCodeDAO analysisCodeDAO = new AnalysisCodeDAO();
            return analysisCodeDAO.GetAnalysisCode(analysisCodeId);
        }

        /// <summary>
        /// GetAnalysisCodes
        /// Obtiene listado de Códigos de Analisis
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AnalysisCode></returns>
        public List<GeneralLedgerModels.AnalysisCode> GetAnalysisCodes()
        {
            AnalysisCodeDAO analysisCodeDAO = new AnalysisCodeDAO();
            return analysisCodeDAO.GetAnalysisCodes();
        }

        #endregion AnalysisCode

        #region AnalysisTreatment

        /// <summary>
        /// SaveAnalysisTreatment
        /// Guarda Tratamiento de Analisis
        /// </summary>
        /// <param name="analysisTreatment"></param>
        /// <returns>AnalysisTreatment</returns>
        public GeneralLedgerModels.AnalysisTreatment SaveAnalysisTreatment(GeneralLedgerModels.AnalysisTreatment analysisTreatment)
        {
            try
            {
                AnalysisTreatmentDAO analysisTreatmentDAO = new AnalysisTreatmentDAO();
                analysisTreatment = analysisTreatmentDAO.SaveAnalysisTreatment(analysisTreatment);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisTreatment;
        }

        /// <summary>
        /// UpdateAnalysisTreatment
        /// Actualiza Tratamiento de Analisis
        /// </summary>
        /// <param name="analysisTreatment"></param>
        /// <returns>AnalysisTreatment</returns>
        public GeneralLedgerModels.AnalysisTreatment UpdateAnalysisTreatment(GeneralLedgerModels.AnalysisTreatment analysisTreatment)
        {
            try
            {
                AnalysisTreatmentDAO analysisTreatmentDAO = new AnalysisTreatmentDAO();
                analysisTreatment = analysisTreatmentDAO.UpdateAnalysisTreatment(analysisTreatment);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisTreatment;
        }

        /// <summary>
        /// DeleteAnalysisTreatment
        /// Borra Tratamiento de Analisis
        /// </summary>
        /// <param name="analysisTreatmentId"></param>
        public void DeleteAnalysisTreatment(int analysisTreatmentId)
        {
            try
            {
                AnalysisTreatmentDAO analysisTreatmentDAO = new AnalysisTreatmentDAO();
                analysisTreatmentDAO.DeleteAnalysisTreatment(analysisTreatmentId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAnalysisTreatment
        /// Obtiene Tratamiento de análisis
        /// </summary>
        /// <param name="analysisTreatmentId"></param>
        /// <returns>AnalysisTreatment</returns>
        public GeneralLedgerModels.AnalysisTreatment GetAnalysisTreatment(int analysisTreatmentId)
        {
            AnalysisTreatmentDAO analysisTreatmentDAO = new AnalysisTreatmentDAO();
            return analysisTreatmentDAO.GetAnalysisTreatment(analysisTreatmentId);
        }

        /// <summary>
        /// GetAnalysisTreatments
        /// Obtiene listado de Tratamientos de análisis
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AnalysisTreatment></returns>
        public List<GeneralLedgerModels.AnalysisTreatment> GetAnalysisTreatments()
        {
            AnalysisTreatmentDAO analysisTreatmentDAO = new AnalysisTreatmentDAO();
            return analysisTreatmentDAO.GetAnalysisTreatments();
        }

        #endregion AnalysisTreatment

        #region AnalysisConcept

        /// <summary>
        /// SaveAnalysisConcept
        /// Guarda Concepto de Análisis
        /// </summary>
        /// <param name="analysisConcept"></param>
        /// <returns>AnalysisConcept</returns>
        public GeneralLedgerModels.AnalysisConcept SaveAnalysisConcept(GeneralLedgerModels.AnalysisConcept analysisConcept)
        {
            try
            {
                AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
                analysisConcept = analysisConceptDAO.SaveAnalysisConcept(analysisConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisConcept;
        }

        /// <summary>
        /// UpdateAnalysisConcept
        /// Actualiza Concepto de Análisis
        /// </summary>
        /// <param name="analysisConcept"></param>
        /// <returns>AnalysisConcept</returns>
        public GeneralLedgerModels.AnalysisConcept UpdateAnalysisConcept(GeneralLedgerModels.AnalysisConcept analysisConcept)
        {
            try
            {
                AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
                analysisConcept = analysisConceptDAO.UpdateAnalysisConcept(analysisConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisConcept;
        }

        /// <summary>
        /// DeleteAnalysisConcept
        /// Borra Concepto de Análisis
        /// </summary>
        /// <param name="analysisConceptId"></param>
        public void DeleteAnalysisConcept(int analysisConceptId)
        {
            try
            {
                AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
                analysisConceptDAO.DeleteAnalysisConcept(analysisConceptId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAnalysisConcept
        /// Obtiene Concepto de Análisis
        /// </summary>
        /// <param name="analysisConceptId"></param>
        /// <returns>AnalysisConcept</returns>
        public GeneralLedgerModels.AnalysisConcept GetAnalysisConcept(int analysisConceptId)
        {
            AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
            return analysisConceptDAO.GetAnalysisConcept(analysisConceptId);
        }

        /// <summary>
        /// GetAnalysisConcepts
        /// Obtiene listado de Conceptos de Análisis
        /// </summary>
        /// <returns>List<GeneralLedgerModels.AnalysisConcept></returns>
        public List<GeneralLedgerModels.AnalysisConcept> GetAnalysisConcepts()
        {
            AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
            return analysisConceptDAO.GetAnalysisConcepts();
        }

        #endregion AnalysisConcept

        #region AnalysisConceptKey

        /// <summary>
        /// SaveAnalysisConceptKey 
        /// Guardar clave de concepto de Análisis
        /// </summary>
        /// <param name="analysisConceptKey"></param>
        /// <returns>AnalysisConceptKey</returns>
        public GeneralLedgerModels.AnalysisConceptKey SaveAnalysisConceptKey(GeneralLedgerModels.AnalysisConceptKey analysisConceptKey)
        {
            try
            {
                AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
                analysisConceptKey = analysisConceptKeyDAO.SaveAnalysisConceptKey(analysisConceptKey);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisConceptKey;
        }

        /// <summary>
        /// UpdateAnalysisConceptKey
        /// </summary>
        /// <param name="analysisConceptKey"></param>
        /// <returns>AnalysisConceptKey</returns>
        public GeneralLedgerModels.AnalysisConceptKey UpdateAnalysisConceptKey(GeneralLedgerModels.AnalysisConceptKey analysisConceptKey)
        {
            try
            {
                AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
                analysisConceptKey = analysisConceptKeyDAO.UpdateAnalysisConceptKey(analysisConceptKey);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return analysisConceptKey;
        }

        /// <summary>
        /// DeleteAnalysisConceptKey
        /// </summary>
        /// <param name="analysisConceptKey"></param>
        public void DeleteAnalysisConceptKey(GeneralLedgerModels.AnalysisConceptKey analysisConceptKey)
        {
            try
            {
                AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
                analysisConceptKeyDAO.DeleteAnalysisConceptKey(analysisConceptKey);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetAnalysisConceptKey
        /// </summary>
        /// <param name="analysisConceptKey"></param>
        /// <returns>AnalysisConceptKey</returns>
        public GeneralLedgerModels.AnalysisConceptKey GetAnalysisConceptKey(GeneralLedgerModels.AnalysisConceptKey analysisConceptKey)
        {
            AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
            return analysisConceptKeyDAO.GetAnalysisConceptKey(analysisConceptKey);
        }

        /// <summary>
        /// GetAnalysisConceptKeys
        /// </summary>
        /// <returns>List<AnalysisConceptKey/></returns>
        public List<GeneralLedgerModels.AnalysisConceptKey> GetAnalysisConceptKeys()
        {
            AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
            return analysisConceptKeyDAO.GetAnalysisConceptKeys();
        }

        /// <summary>
        /// GetAnalysisConceptKeysByAnalysisConcept
        /// </summary>
        /// <param name="analysisConcept"></param>
        /// <returns>List<AnalysisConceptKey/></returns>
        public List<GeneralLedgerModels.AnalysisConceptKey> GetAnalysisConceptKeysByAnalysisConcept(GeneralLedgerModels.AnalysisConcept analysisConcept)
        {
            AnalysisConceptKeyDAO analysisConceptKeyDAO = new AnalysisConceptKeyDAO();
            return analysisConceptKeyDAO.GetAnalysisConceptKeysByAnalysisConcept(analysisConcept);
        }

        #endregion

        #region AnalysisConceptAnalysis

        /// <summary>
        /// SaveAnalysisConceptAnalysis
        /// Graba relación Analisis y Concepto de Analisis
        /// </summary>
        /// <param name="analysisId"></param>
        /// <param name="analysisConceptId"></param>
        public void SaveAnalysisConceptAnalysis(int analysisId, int analysisConceptId)
        {
            try
            {
                AnalysisConceptAnalysisDAO analysisConceptAnalysisDAO = new AnalysisConceptAnalysisDAO();
                analysisConceptAnalysisDAO.SaveAnalysisConceptAnalysis(analysisId, analysisConceptId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// DeleteAnalysisConceptAnalysis
        /// Borra relación Analisis y Concepto de Analisis
        /// </summary>
        /// <param name="analysisConceptAnalysisId"></param>
        public void DeleteAnalysisConceptAnalysis(int analysisConceptAnalysisId)
        {
            try
            {
                AnalysisConceptAnalysisDAO analysisConceptAnalysisDAO = new AnalysisConceptAnalysisDAO();
                analysisConceptAnalysisDAO.DeleteAnalysisConceptAnalysis(analysisConceptAnalysisId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetPaymentConceptsByAnalysisCode
        /// Obtiene los conceptos de pago a partir del Analisis
        /// </summary>
        /// <param name="analysisId"></param>
        /// <returns>List<AnalysisConceptAnalysisDTO></returns>
        public List<AnalysisConceptAnalysisDTO> GetPaymentConceptsByAnalysisCode(int analysisId)
        {
            List<AnalysisConceptAnalysisDTO> analysisConcepts = new List<AnalysisConceptAnalysisDTO>();
            AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();
            AnalysisConceptAnalysisDAO analysisConceptAnalysisDAO = new AnalysisConceptAnalysisDAO();

            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.PropertyEquals(AnalysisConceptAnalysis.Properties.AnalysisId, analysisId);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AnalysisConceptAnalysis), criteriaBuilder.GetPredicate()));

            if (businessCollection.Count > 0)
            {
                foreach (AnalysisConceptAnalysis analysisConceptAnalysisEntity in businessCollection.OfType<AnalysisConceptAnalysis>())
                {
                    try
                    {
                        AnalysisConceptAnalysisDTO analysisConceptAnalysisDTO = new AnalysisConceptAnalysisDTO();
                        // Se obtiene los datos del concepto de análisis para llenarlos en el dto
                        GeneralLedgerModels.AnalysisConcept analysisConcept = analysisConceptDAO.GetAnalysisConcept(Convert.ToInt32(analysisConceptAnalysisEntity.AnalysisConceptId));
                        analysisConceptAnalysisDTO.AnalysisConceptAnalysisId = analysisConceptAnalysisEntity.AnalysisConceptAnalysisId;
                        analysisConceptAnalysisDTO.AnalysisId = Convert.ToInt32(analysisConceptAnalysisEntity.AnalysisId);
                        analysisConceptAnalysisDTO.AnalysisConceptId = analysisConcept.AnalysisConceptId;
                        analysisConceptAnalysisDTO.AnalysisConceptDescription = analysisConcept.Description;
                        analysisConcepts.Add(analysisConceptAnalysisDTO);
                    }
                    catch (BusinessException)
                    {
                        // En caso de haber sido borrado o cambiado un AnalisisConcept se borra la relación para evitar errores futuros
                        analysisConceptAnalysisDAO.DeleteAnalysisConceptAnalysis(analysisConceptAnalysisEntity.AnalysisConceptAnalysisId);
                    }
                }
            }

            return analysisConcepts;
        }

        /// <summary>
        /// GetRemainingAnalysisConcepts
        /// Obtiene los conceptos de pago que aún no han sido relacionados con el Analisis
        /// </summary>
        /// <param name="analysisCodeId"></param>
        /// <returns>List<GeneralLedgerModels.AnalysisConcept></returns>
        public List<GeneralLedgerModels.AnalysisConcept> GetRemainingAnalysisConcepts(int analysisCodeId)
        {
            List<GeneralLedgerModels.AnalysisConcept> analysisConcepts = new List<GeneralLedgerModels.AnalysisConcept>();
            AnalysisConceptDAO analysisConceptDAO = new AnalysisConceptDAO();

            // Hago select a la tabla analysisConceptAnalysis
            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.Property(AnalysisConceptAnalysis.Properties.AnalysisConceptAnalysisId);
            criteriaBuilder.GreaterEqual();
            criteriaBuilder.Constant(0);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AnalysisConceptAnalysis), criteriaBuilder.GetPredicate()));

            // Hago select a la tabla analysisConcept
            criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.Property(AnalysisConcept.Properties.AnalysisConceptId);
            criteriaBuilder.GreaterEqual();
            criteriaBuilder.Constant(0);
            BusinessCollection conceptBusinessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AnalysisConcept), criteriaBuilder.GetPredicate()));

            // Se obtiene los registros de analysisConceptAnalysis que complen con la condición de ser igual al parametro analysisCodeId
            var innerQuery = from AnalysisConceptAnalysis analysisConceptAnalysis in businessCollection where analysisConceptAnalysis.AnalysisId == analysisCodeId select analysisConceptAnalysis.AnalysisConceptId;

            //Obtengo los registros de analysisConcept que no se encuentran dentro de la consulta anterior(not in innerQuery)
            var concepts = from AnalysisConcept analysisConcept in conceptBusinessCollection where !innerQuery.Contains(analysisConcept.AnalysisConceptId) select analysisConcept;

            foreach (AnalysisConcept analysisConceptEntity in concepts)
            {
                GeneralLedgerModels.AnalysisConcept analysisConcept = analysisConceptDAO.GetAnalysisConcept(analysisConceptEntity.AnalysisConceptId);
                analysisConcepts.Add(analysisConcept);
            }

            return analysisConcepts;
        }

        #endregion AnalysisConceptAnalysis

        #region BankReconciliation

        /// <summary>
        /// SaveReconciliationMovementType
        /// </summary>
        /// <param name="reconciliationMovementType"></param>
        public void SaveReconciliationMovementType(GeneralLedgerModels.ReconciliationMovementType reconciliationMovementType)
        {
            ReconciliationMovementTypeDAO reconciliationMovementTypeDAO = new ReconciliationMovementTypeDAO();
            reconciliationMovementTypeDAO.SaveReconciliationMovementType(reconciliationMovementType);
        }

        /// <summary>
        /// UpdateReconciliationMovementType
        /// </summary>
        /// <param name="reconciliationMovementType"></param>
        public void UpdateReconciliationMovementType(GeneralLedgerModels.ReconciliationMovementType reconciliationMovementType)
        {
            ReconciliationMovementTypeDAO reconciliationMovementTypeDAO = new ReconciliationMovementTypeDAO();
            reconciliationMovementTypeDAO.UpdateReconciliationMovementType(reconciliationMovementType);
        }

        /// <summary>
        /// DeleteReconciliationMovementType
        /// </summary>
        /// <param name="reconciliationMovementType"></param>
        /// <returns>bool</returns>
        public bool DeleteReconciliationMovementType(GeneralLedgerModels.ReconciliationMovementType reconciliationMovementType)
        {
            ReconciliationMovementTypeDAO reconciliationMovementTypeDAO = new ReconciliationMovementTypeDAO();
            return reconciliationMovementTypeDAO.DeleteReconciliationMovementType(reconciliationMovementType);
        }

        /// <summary>
        /// GetReconciliationMovementTypes
        /// Carga listado de conciliaciones  bancarias
        /// </summary>
        /// <returns>List<GeneralLedgerModels.ReconciliationMovementType></returns>
        public List<GeneralLedgerModels.ReconciliationMovementType> GetReconciliationMovementTypes()
        {
            try
            {
                ReconciliationMovementTypeDAO reconciliationMovementTypeDAO = new ReconciliationMovementTypeDAO();
                return reconciliationMovementTypeDAO.GetReconciliationMovementTypes();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion BankReconciliation

        #region CostCenter

        /// <summary>
        /// SaveCostCenter
        /// Guarda Centro de costos
        /// </summary>
        /// <param name="costCenter"></param>
        /// <returns>CostCenter</returns>
        public GeneralLedgerModels.CostCenter SaveCostCenter(GeneralLedgerModels.CostCenter costCenter)
        {
            try
            {
                CostCenterDAO costCenterDAO = new CostCenterDAO();
                costCenter = costCenterDAO.SaveCostCenter(costCenter);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return costCenter;
        }

        /// <summary>
        /// UpdateCostCenter
        /// Actualiza Centro de costos
        /// </summary>
        /// <param name="costCenter"></param>
        /// <returns>CostCenter</returns>
        public GeneralLedgerModels.CostCenter UpdateCostCenter(GeneralLedgerModels.CostCenter costCenter)
        {
            try
            {
                CostCenterDAO costCenterDAO = new CostCenterDAO();
                costCenter = costCenterDAO.UpdateCostCenter(costCenter);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return costCenter;
        }

        /// <summary>
        /// DeleteCostCenter
        /// Borra Centro de costos
        /// </summary>
        /// <param name="costCenterId"></param>
        /// <returns>bool</returns>
        public bool DeleteCostCenter(int costCenterId)
        {
            bool isDeleted;

            try
            {
                CostCenterDAO costCenterDAO = new CostCenterDAO();

                // Se obtiene datos de las cuentas contables asociadas a un centro de costo
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(AccountingAccountCostCenter.Properties.CostCenterId, costCenterId);
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AccountingAccountCostCenter), criteriaBuilder.GetPredicate()));

                isDeleted = businessCollection.Count == 0 && costCenterDAO.DeleteCostCenter(costCenterId);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return isDeleted;
        }

        /// <summary>
        /// GetCostCenter
        /// Obtiene Centro de costos
        /// </summary>
        /// <param name="costCenter"></param>
        /// <returns>CostCenter</returns>
        public GeneralLedgerModels.CostCenter GetCostCenter(Models.CostCenter costCenter)
        {
            CostCenterDAO costCenterDAO = new CostCenterDAO();
            costCenter = costCenterDAO.GetCostCenter(costCenter);
            costCenter.CostCenterType = GetCostCenterTypeById(costCenter.CostCenterType.CostCenterTypeId);
            return costCenter;
        }

        /// <summary>
        /// GetCostCenters
        /// Obtiene listado de Centros de costos
        /// </summary>
        /// <returns>List<GeneralLedgerModels.CostCenter></returns>
        public List<GeneralLedgerModels.CostCenter> GetCostCenters()
        {
            CostCenterDAO costCenterDAO = new CostCenterDAO();

            var costCenters = costCenterDAO.GetCostCenters();

            return costCenters.Select(GetCostCenter).ToList();
        }

        #endregion CostCenter

        #region CostCenterType

        /// <summary>
        /// SaveCostCenterType
        /// Guarda Tipo de centro de costos
        /// </summary>
        /// <param name="costCenterType"></param>
        public void SaveCostCenterType(GeneralLedgerModels.CostCenterType costCenterType)
        {
            try
            {
                CostCenterTypeDAO costCenterTypeDAO = new CostCenterTypeDAO();
                costCenterTypeDAO.SaveCostCenterType(costCenterType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// UpdateCostCenterType
        /// Actualiza Tipo de centro de costos
        /// </summary>
        /// <param name="costCenterType"></param>
        public void UpdateCostCenterType(GeneralLedgerModels.CostCenterType costCenterType)
        {
            try
            {
                CostCenterTypeDAO costCenterTypeDAO = new CostCenterTypeDAO();
                costCenterTypeDAO.UpdateCostCenterType(costCenterType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// DeleteCostCenterType
        /// Borra Tipo de centro de costos
        /// </summary>
        /// <param name="costCenterTypeId"></param>
        /// <returns>bool</returns>
        public bool DeleteCostCenterType(int costCenterTypeId)
        {
            bool isDeleted;

            try
            {
                CostCenterTypeDAO costCenterTypeDAO = new CostCenterTypeDAO();
                isDeleted = costCenterTypeDAO.DeleteCostCenterType(costCenterTypeId);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return isDeleted;
        }

        /// <summary>
        /// GetCostCenterTypeById
        /// Obtiene Tipo de centro de costos
        /// </summary>
        /// <param name="costCenterTypeId"></param>
        /// <returns>CostCenterType</returns>
        public GeneralLedgerModels.CostCenterType GetCostCenterTypeById(int costCenterTypeId)
        {
            CostCenterTypeDAO costCenterTypeDAO = new CostCenterTypeDAO();
            return costCenterTypeDAO.GetCostCenterTypeById(costCenterTypeId);
        }

        /// <summary>
        /// GetCostCenterTypes
        /// Obtiene listado de Tipos de centro de costos
        /// </summary>
        /// <returns>List<GeneralLedgerModels.CostCenterType></returns>
        public List<GeneralLedgerModels.CostCenterType> GetCostCenterTypes()
        {
            try
            {
                CostCenterTypeDAO costCenterTypeDAO = new CostCenterTypeDAO();
                return costCenterTypeDAO.GetCostCenterTypes();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion CostCenterType

        #region EntryDestination

        /// <summary>
        /// SaveDestination
        /// Guarda Destino
        /// </summary>
        /// <param name="entryDestination"></param>
        /// <returns>EntryDestination</returns>
        public GeneralLedgerModels.EntryDestination SaveEntryDestination(GeneralLedgerModels.EntryDestination entryDestination)
        {
            try
            {
                DestinationDAO destinationDAO = new DestinationDAO();
                entryDestination = destinationDAO.SaveEntryDestination(entryDestination);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return entryDestination;
        }

        /// <summary>
        /// UpdateDestination
        /// Actualiza Destino
        /// </summary>
        /// <param name="entryDestination"></param>
        /// <returns>EntryDestination</returns>
        public GeneralLedgerModels.EntryDestination UpdateEntryDestination(GeneralLedgerModels.EntryDestination entryDestination)
        {
            try
            {
                DestinationDAO destinationDAO = new DestinationDAO();
                entryDestination = destinationDAO.UpdateEntryDestination(entryDestination);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return entryDestination;
        }

        /// <summary>
        /// DeleteEntryDestination
        /// Borra Destino
        /// </summary>
        /// <param name="entryDestinationId"></param>
        public void DeleteEntryDestination(int entryDestinationId)
        {
            try
            {
                DestinationDAO destinationDAO = new DestinationDAO();
                destinationDAO.DeleteEntryDestination(entryDestinationId);
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }
        }

        /// <summary>
        /// GetDestination
        /// Obtiene un Destino
        /// </summary>
        /// <param name="entryDestination"></param>
        /// <returns>EntryDestination</returns>
        public GeneralLedgerModels.EntryDestination GetDestination(GeneralLedgerModels.EntryDestination entryDestination)
        {
            DestinationDAO destinationDAO = new DestinationDAO();
            return destinationDAO.GetEntryDestination(entryDestination);
        }

        /// <summary>
        /// GetEntryDestinations
        /// Obtiene listado de Destinos
        /// </summary>
        /// <returns>List<EntryDestination/></returns>
        public List<GeneralLedgerModels.EntryDestination> GetEntryDestinations()
        {
            DestinationDAO destinationDAO = new DestinationDAO();
            return destinationDAO.GetEntryDestinations();
        }

        #endregion Destination

        #region EntryType

        /// <summary>
        /// SaveEntryType
        /// Guarda Asiento Tipo
        /// </summary>
        /// <param name="entryType"></param>
        /// <returns>EntryType</returns>
        public GeneralLedgerModels.EntryType SaveEntryType(GeneralLedgerModels.EntryType entryType)
        {
            try
            {
                EntryTypeDAO entryTypeDAO = new EntryTypeDAO();
                entryType = entryTypeDAO.SaveEntryType(entryType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return entryType;
        }

        /// <summary>
        /// UpdateEntryType
        /// Actualiza Asiento Tipo
        /// </summary>
        /// <param name="entryType"></param>
        public void UpdateEntryType(GeneralLedgerModels.EntryType entryType)
        {
            try
            {
                EntryTypeDAO entryTypeDAO = new EntryTypeDAO();
                entryTypeDAO.UpdateEntryType(entryType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// DeleteEntryTypeRequest
        /// Borra Asiento Tipo
        /// </summary>
        /// <param name="entryTypeId"></param>
        public void DeleteEntryTypeRequest(int entryTypeId)
        {
            try
            {
                EntryTypeDAO entryTypeDAO = new EntryTypeDAO();

                // Se obtiene las cuentas relacionadas al tipo de asiento
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(EntryTypeItem.Properties.EntryTypeId, entryTypeId);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(EntryTypeItem), criteriaBuilder.GetPredicate()));

                // Se borra las cuentas relacionadas
                if (businessCollection.Count > 0)
                {
                    foreach (EntryTypeItem entryTypeItemEntity in businessCollection.OfType<EntryTypeItem>())
                    {
                        entryTypeDAO.DeleteEntryTypeItem(entryTypeItemEntity.EntryTypeItemId);
                    }
                }

                // Se borra el asiento
                GeneralLedgerModels.EntryType entryType = new GeneralLedgerModels.EntryType();
                entryType.EntryTypeId = entryTypeId;

                entryTypeDAO.DeleteEntryType(entryType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetEntryType
        /// Obtiene Asiento Tipo
        /// </summary>
        /// <param name="entryType"></param>
        /// <returns>EntryType</returns>
        public GeneralLedgerModels.EntryType GetEntryType(GeneralLedgerModels.EntryType entryType)
        {
            EntryTypeDAO entryTypeDAO = new EntryTypeDAO();
            EntryTypeAccountingDAO entryTypeAccountingDAO = new EntryTypeAccountingDAO();
            var criteriaBuilder = new ObjectCriteriaBuilder();
            var entryTypeItems = new List<GeneralLedgerModels.EntryTypeItem>();

            try
            {
                var newEntryType = entryTypeDAO.GetEntryType(entryType);

                if (entryType != null)
                {
                    criteriaBuilder.PropertyEquals(EntryTypeItem.Properties.EntryTypeId, entryType.EntryTypeId);
                }
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(EntryTypeItem), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count != 0)
                {
                    foreach (EntryTypeItem entryTypeItemEntity in businessCollection.OfType<EntryTypeItem>())
                    {
                        var entryTypeItem = new GeneralLedgerModels.EntryTypeItem();
                        entryTypeItem.Id = entryTypeItemEntity.EntryTypeItemId;
                        entryTypeItem = entryTypeAccountingDAO.GetEntryTypeItem(entryTypeItem);
                        entryTypeItems.Add(entryTypeItem);
                    }
                }
                newEntryType.EntryTypeItems = entryTypeItems;
                return newEntryType;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetEntryTypes
        /// Obtiene listado de Asientos Tipo
        /// </summary>
        /// <returns>List<EntryType></returns>
        public List<GeneralLedgerModels.EntryType> GetEntryTypes()
        {
            try
            {
                EntryTypeDAO entryTypeDAO = new EntryTypeDAO();
                return entryTypeDAO.GetEntryTypes();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion EntryType

        #region EntryTypeItem

        /// <summary>
        /// SaveLedgerEntryItem
        /// Guarda Cuenta contable relacionada al Asiento tipo
        /// </summary>
        /// <param name="ledgerEntryItem"></param>
        /// <returns>int</returns>
        public int SaveLedgerEntryItem(GeneralLedgerModels.LedgerEntryItem ledgerEntryItem)
        {
            return ledgerEntryItem.Id;
        }

        /// <summary>
        /// UpdateLedgerEntryItem
        /// Actualiza Cuenta contable relacionada al Asiento tipo
        /// </summary>
        /// <param name="ledgerEntryItem"></param>
        /// <returns>int</returns>
        public int UpdateLedgerEntryItem(GeneralLedgerModels.LedgerEntryItem ledgerEntryItem)
        {
            return ledgerEntryItem.Id;
        }

        /// <summary>
        /// DeleteEntryTypeAccounting
        /// Borra Cuenta contable relacionada al Asiento tipo
        /// </summary>
        /// <param name="entryTypeAccountingId"></param>
        /// <returns>bool</returns>
        public bool DeleteEntryTypeAccounting(int entryTypeAccountingId)
        {
            bool isDeleted;

            try
            {
                EntryTypeAccountingDAO entryTypeAccountingDAO = new EntryTypeAccountingDAO();
                isDeleted = entryTypeAccountingDAO.DeleteEntryTypeAccounting(entryTypeAccountingId);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return isDeleted;
        }

        #endregion EntryTypeItem

        #region EntryNumber

        #endregion EntryNumber

        #region CorrelativeNumber

        /// <summary>
        /// GetCorrelativeNumber
        /// Obtiene el número correlativo para la tabla Entry Análisis 
        /// </summary>
		/// <param name="analysisCodeId"></param>
		/// <param name="analysisConceptId"></param>
		/// <param name="key"></param>
        /// <returns>int</returns>
        public int GetCorrelativeNumber(int analysisCodeId, int analysisConceptId, string key)
        {
            int correlativeNumber = 0;

            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();

            criteriaBuilder.PropertyEquals(AnalysisEntryItem.Properties.AnalysisId, analysisCodeId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(AnalysisEntryItem.Properties.AnalysisConceptId, analysisConceptId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(AnalysisEntryItem.Properties.ConceptKey, key);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AnalysisEntryItem), criteriaBuilder.GetPredicate()));

            if (businessCollection.Count > 0)
            {
                var maxNumber = (from AnalysisEntryItem entryAnalisis in businessCollection select entryAnalisis.CorrelativeNumber).Max();
                correlativeNumber = Convert.ToInt32(maxNumber);
            }
            else
            {
                correlativeNumber = 1;
            }

            return correlativeNumber;
        }

        #endregion CorrelativeNumber

        #region ConceptSource

        /// <summary>
        /// SaveConceptSource
        /// </summary>
        /// <param name="conceptSource"></param>
        /// <returns>ConceptSource</returns>
        public AccountingConceptModels.ConceptSource SaveConceptSource(AccountingConceptModels.ConceptSource conceptSource)
        {
            try
            {
                ConceptSourceDAO conceptSourceDAO = new ConceptSourceDAO();
                conceptSource = conceptSourceDAO.SaveConceptSource(conceptSource);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return conceptSource;
        }

        /// <summary>
        /// UpdateConceptSource
        /// </summary>
        /// <param name="conceptSource"></param>
        /// <returns>ConceptSource</returns>
        public AccountingConceptModels.ConceptSource UpdateConceptSource(AccountingConceptModels.ConceptSource conceptSource)
        {
            try
            {
                ConceptSourceDAO conceptSourceDAO = new ConceptSourceDAO();
                conceptSource = conceptSourceDAO.UpdateConceptSource(conceptSource);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return conceptSource;
        }

        /// <summary>
        /// DeleteConceptSource
        /// </summary>
        /// <param name="conceptSource">conceptSource</param>
        /// <returns>bool</returns>
        public bool DeleteConceptSource(AccountingConceptModels.ConceptSource conceptSource)
        {
            bool deleted;
            try
            {
                ConceptSourceDAO conceptSourceDAO = new ConceptSourceDAO();
                deleted = conceptSourceDAO.DeleteConceptSource(conceptSource);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return deleted;
        }

        /// <summary>
        /// GetConceptSource
        /// </summary>
        /// <param name="conceptSource"></param>
        /// <returns>ConceptSource</returns>
        public AccountingConceptModels.ConceptSource GetConceptSource(AccountingConceptModels.ConceptSource conceptSource)
        {
            ConceptSourceDAO conceptSourceDAO = new ConceptSourceDAO();
            return conceptSourceDAO.GetConceptSource(conceptSource);
        }

        /// <summary>
        /// GetConceptSources
        /// </summary>
        /// <returns>List<ConceptSource/></returns>
        public List<AccountingConceptModels.ConceptSource> GetConceptSources()
        {
            ConceptSourceDAO conceptSourceDAO = new ConceptSourceDAO();
            return conceptSourceDAO.GetConceptSources();
        }

        #endregion

        #region MovementType

        /// <summary>
        /// SaveMovementType
        /// </summary>
        /// <param name="movementType"></param>
        /// <returns>MovementType</returns>
        public AccountingConceptModels.MovementType SaveMovementType(AccountingConceptModels.MovementType movementType)
        {
            try
            {
                MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
                movementType = movementTypeDAO.SaveMovementType(movementType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return movementType;
        }

        /// <summary>
        /// UpdateMovementType
        /// </summary>
        /// <param name="movementType"></param>
        /// <returns>MovementType</returns>
        public AccountingConceptModels.MovementType UpdateMovementType(AccountingConceptModels.MovementType movementType)
        {
            try
            {
                MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
                movementType = movementTypeDAO.UpdateMovementType(movementType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return movementType;
        }


        /// <summary>
        /// DeleteMovementType
        /// </summary>
        /// <param name="movementType"></param>
        /// <returns>bool</returns>
        public bool DeleteMovementType(AccountingConceptModels.MovementType movementType)
        {

            bool deleted;
            try
            {
                MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
                deleted = movementTypeDAO.DeleteMovementType(movementType);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return deleted;
        }

        /// <summary>
        /// GetMovementType
        /// </summary>
        /// <param name="movementType"></param>
        /// <returns>MovementType</returns>      
        public AccountingConceptModels.MovementType GetMovementType(AccountingConceptModels.MovementType movementType)
        {
            MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
            return movementTypeDAO.GetMovementType(movementType);
        }

        /// <summary>
        /// GetMovementTypes
        /// </summary>
        /// <returns>List<MovementType/></returns>
        public List<AccountingConceptModels.MovementType> GetMovementTypes()
        {
            MovementTypeDAO movementTypeDAO = new MovementTypeDAO();

            return movementTypeDAO.GetMovementTypes();
        }

        /// <summary>
        /// GetMovementTypesByConceptSource
        /// </summary>
        /// <param name="conceptSource"></param>
        /// <returns>List<MovementType/></returns>
        public List<AccountingConceptModels.MovementType> GetMovementTypesByConceptSource(AccountingConceptModels.ConceptSource conceptSource)
        {
            MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
            return movementTypeDAO.GetMovementTypesByConceptSource(conceptSource);
        }

        /// <summary>
        /// GetMovementTypesByConceptSource
        /// </summary>
        /// <param name="conceptSource"></param>
        /// <returns>List<MovementType/></returns>
        public List<AccountingConceptModels.MovementType> GetMovementTypesByConceptSourceFilter(AccountingConceptModels.ConceptSource conceptSource)
        {
            MovementTypeDAO movementTypeDAO = new MovementTypeDAO();
            return movementTypeDAO.GetMovementTypesByConceptSourceFilter(conceptSource);
        }

        #endregion

        #region AccountingConcept

        /// <summary>
        /// SaveAccountingConcept
        /// Guardar Conceptos Contables 
        /// </summary>
        /// <param name="accountingConcept"></param>
        /// <returns>AccountingConcept</returns>
        public AccountingConceptModels.AccountingConcept SaveAccountingConcept(AccountingConceptModels.AccountingConcept accountingConcept)
        {
            try
            {
                AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
                accountingConcept = accountingConceptDAO.SaveAccountingConcept(accountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingConcept;
        }

        /// <summary>
        /// UpdateAccountingConcept
        /// </summary>
        /// <param name="accountingConcept"></param>
        /// <returns>AccountingConcept</returns>
        public AccountingConceptModels.AccountingConcept UpdateAccountingConcept(AccountingConceptModels.AccountingConcept accountingConcept)
        {
            try
            {
                AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
                accountingConcept = accountingConceptDAO.UpdateAccountingConcept(accountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingConcept;
        }

        /// <summary>
        /// DeleteAccountingConcept
        /// </summary>
        /// <param name="accountingConcept"></param>
        /// <returns>bool</returns>   
        public bool DeleteAccountingConcept(AccountingConceptModels.AccountingConcept accountingConcept)
        {
            bool deleted;
            try
            {
                AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
                deleted = accountingConceptDAO.DeleteAccountingConcept(accountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return deleted;
        }

        /// <summary>
        /// GetAccountingConcept
        /// </summary>
        /// <param name="accountingConcept"></param>
        /// <returns>AccountingConcept</returns>     
        public AccountingConceptModels.AccountingConcept GetAccountingConcept(AccountingConceptModels.AccountingConcept accountingConcept)
        {
            AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
            return accountingConceptDAO.GetAccountingConcept(accountingConcept);
        }

        /// <summary>
        /// GetAccountingConcepts
        /// </summary>        
        /// <returns>List<AccountingConcept/></returns>        
        public List<AccountingConceptModels.AccountingConcept> GetAccountingConcepts()
        {
            AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
            return accountingConceptDAO.GetAccountingConcepts();
        }

        /// <summary>
        /// GetAccountingConceptsByCriteria
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="branchId"></param>
        /// <param name="individualId"></param>
        /// <returns>List<AccountingConcept/></returns>
        public List<AccountingConceptModels.AccountingConcept> GetAccountingConceptsByCriteria(int userId, int branchId, int individualId)
        {
            AccountingConceptDAO accountingConceptDAO = new AccountingConceptDAO();
            return accountingConceptDAO.GetAccountingConceptsByCriteria(userId, branchId, individualId);
        }

        #endregion

        #region BranchAccountingConcept

        /// <summary>
        /// SaveBranchAccountingConcept
        /// </summary>
        /// <param name="branchAccountingConcept"></param>
        /// <returns>BranchAccountingConcept</returns>
        public AccountingConceptModels.BranchAccountingConcept SaveBranchAccountingConcept(AccountingConceptModels.BranchAccountingConcept branchAccountingConcept)
        {
            try
            {
                BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
                branchAccountingConcept = branchAccountingConceptDAO.SaveBranchAccountingConcept(branchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return branchAccountingConcept;
        }

        /// <summary>
        /// UpdateBranchAccountingConcept
        /// </summary>
        /// <param name="branchAccountingConcept"></param>
        /// <returns>BranchAccountingConcept</returns>
        public AccountingConceptModels.BranchAccountingConcept UpdateBranchAccountingConcept(AccountingConceptModels.BranchAccountingConcept branchAccountingConcept)
        {
            try
            {
                BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
                branchAccountingConcept = branchAccountingConceptDAO.UpdateBranchAccountingConcept(branchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return branchAccountingConcept;
        }

        /// <summary>
        /// DeleteBranchAccountingConcept
        /// </summary>
        /// <param name="branchAccountingConcept"></param>
        /// <returns>bool</returns>
        public bool DeleteBranchAccountingConcept(AccountingConceptModels.BranchAccountingConcept branchAccountingConcept)
        {
            bool deleted;
            try
            {
                BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
                deleted = branchAccountingConceptDAO.DeleteBranchAccountingConcept(branchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return deleted;
        }

        /// <summary>
        /// GetBranchAccountingConcept
        /// </summary>
        /// <param name="branchAccountingConcept"></param>
        /// <returns>BranchAccountingConcept</returns>
        public AccountingConceptModels.BranchAccountingConcept GetBranchAccountingConcept(AccountingConceptModels.BranchAccountingConcept branchAccountingConcept)
        {
            BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
            return branchAccountingConceptDAO.GetBranchAccountingConcept(branchAccountingConcept);
        }

        /// <summary>
        /// GetBranchAccountingConcepts
        /// </summary>
        /// <returns>List<BranchAccountingConcept/></returns>
        public List<AccountingConceptModels.BranchAccountingConcept> GetBranchAccountingConcepts()
        {
            BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
            return branchAccountingConceptDAO.GetBranchAccountingConcepts();
        }

        /// <summary>
        /// GetBranchAccountingConceptByBranch
        /// </summary>
        /// <param name="branch"></param>
        /// <returns>List<BranchAccountingConcept/></returns>
        public List<AccountingConceptModels.BranchAccountingConcept> GetBranchAccountingConceptByBranch(CommonModels.Branch branch)
        {
            BranchAccountingConceptDAO branchAccountingConceptDAO = new BranchAccountingConceptDAO();
            return branchAccountingConceptDAO.GetBranchAccountingConceptByBranch(branch);
        }

        #endregion

        #region UserBranchAccountingConcept

        /// <summary>
        /// SaveUserBranchAccountingConcept
        /// </summary>
        /// <param name="userBranchAccountingConcept"></param>
        /// <returns>UserBranchAccountingConcept</returns>
        public AccountingConceptModels.UserBranchAccountingConcept SaveUserBranchAccountingConcept(AccountingConceptModels.UserBranchAccountingConcept userBranchAccountingConcept)
        {
            try
            {
                UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
                userBranchAccountingConcept = userBranchAccountingConceptDAO.SaveUserBranchAccountingConcept(userBranchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return userBranchAccountingConcept;
        }

        /// <summary>
        /// UpdateUserBranchAccountingConcept
        /// </summary>
        /// <param name="userBranchAccountingConcept"></param>
        /// <returns>UserBranchAccountingConcept</returns>
        public AccountingConceptModels.UserBranchAccountingConcept UpdateUserBranchAccountingConcept(AccountingConceptModels.UserBranchAccountingConcept userBranchAccountingConcept)
        {
            try
            {
                UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
                userBranchAccountingConcept = userBranchAccountingConceptDAO.UpdateUserBranchAccountingConcept(userBranchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return userBranchAccountingConcept;
        }

        /// <summary>
        /// DeleteUserBranchAccountingConcept
        /// </summary>
        /// <param name="userBranchAccountingConcept"></param>
        /// <returns>bool</returns>
        public bool DeleteUserBranchAccountingConcept(AccountingConceptModels.UserBranchAccountingConcept userBranchAccountingConcept)
        {
            bool deleted;
            try
            {
                UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
                deleted = userBranchAccountingConceptDAO.DeleteUserBranchAccountingConcept(userBranchAccountingConcept);
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
            return deleted;
        }

        /// <summary>
        /// GetUserBranchAccountingConcept
        /// </summary>
        /// <param name="userBranchAccountingConcept"></param>
        /// <returns>UserBranchAccountingConcept</returns>
        public AccountingConceptModels.UserBranchAccountingConcept GetUserBranchAccountingConcept(AccountingConceptModels.UserBranchAccountingConcept userBranchAccountingConcept)
        {
            UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
            return userBranchAccountingConceptDAO.GetUserBranchAccountingConcept(userBranchAccountingConcept);
        }

        /// <summary>
        /// GetUserBranchAccountingConcepts
        /// </summary>
        /// <returns>List<AccountingConceptModels.UserBranchAccountingConcept></returns>
        public List<AccountingConceptModels.UserBranchAccountingConcept> GetUserBranchAccountingConcepts()
        {
            UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
            return userBranchAccountingConceptDAO.GetUserBranchAccountingConcepts();
        }

        /// <summary>
        /// GetUserBranchAccountingConceptByUserByBranch
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="branch"></param>
        /// <returns>List<UserBranchAccountingConcept/></returns>
        public List<AccountingConceptModels.UserBranchAccountingConcept> GetUserBranchAccountingConceptByUserByBranch(int userId, CommonModels.Branch branch)
        {
            UserBranchAccountingConceptDAO userBranchAccountingConceptDAO = new UserBranchAccountingConceptDAO();
            return userBranchAccountingConceptDAO.GetUserBranchAccountingConceptByUserByBranch(userId, branch);
        }

        #endregion


        #endregion PARAM

        #region EntryPosting

        /// <summary>
        /// DaysMonth
        /// Calcula los días del mes de proceso
        /// </summary>
        /// <param name="year"></param>
        /// <param name="month"></param>
        /// <returns>int</returns>
        public int DaysMonth(int year, int month)
        {
            return DateTime.DaysInMonth(year, month);
        }

        /// <summary>
        /// DeleteProcessEntries
        /// Elimina asientos de mayor marcados como CONTABILIDAD DIARIA
        /// </summary>
        /// <param name="year"></param>
        /// <param name="month"></param>
        /// <param name="movementType"></param>
        public void DeleteProcessEntries(int year, int month, int movementType)
        {
            try
            {
                LedgerEntryDAO ledgerEntryDAO = new LedgerEntryDAO();
                int numberOfDays = DateTime.DaysInMonth(year, month);
                string date = Convert.ToString(numberOfDays) + "/" + Convert.ToString(month) + "/" + Convert.ToString(year);
                date = date + " 23:59:59";

                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(new DateTime(year, month, 1));
                criteriaBuilder.And();
                criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
                criteriaBuilder.LessEqual();
                criteriaBuilder.Constant(date);

                if (movementType == 0)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.Property(LedgerEntry.Properties.AccountingMovementTypeId);
                    criteriaBuilder.Equal();
                    criteriaBuilder.Constant(Convert.ToInt32(ConfigurationManager.AppSettings["DailyAccounting"]));
                }
                if (movementType == 1)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(LedgerEntry.Properties.AccountingMovementTypeId, movementType);
                }
                if (movementType == 2)
                {
                    criteriaBuilder.And();
                    criteriaBuilder.Property(LedgerEntry.Properties.AccountingMovementTypeId);
                    criteriaBuilder.Equal();
                    criteriaBuilder.Constant(Convert.ToInt32(ConfigurationManager.AppSettings["AutomaticEntries"]));
                    criteriaBuilder.And();
                    criteriaBuilder.PropertyEquals(Entry.Properties.IsDailyEntry, 1); //indica que fue mayorizacíon de asientos.
                }

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(LedgerEntry), criteriaBuilder.GetPredicate()));

                GeneralLedgerModels.LedgerEntry ledgerEntry = new GeneralLedgerModels.LedgerEntry();
                ledgerEntry.LedgerEntryItems = new List<GeneralLedgerModels.LedgerEntryItem>();

                if (businessCollection.Count > 0)
                {
                    foreach (LedgerEntry ledgerEntryEntity in businessCollection.OfType<LedgerEntry>())
                    {
                        ledgerEntryDAO.DeleteLedgerEntryItem(ledgerEntryEntity.LedgerEntryId);
                        ledgerEntryDAO.DeleteLedgerEntry(ledgerEntryEntity.LedgerEntryId);
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// SaveProcessEntries
        /// Guarda agrupando por cuenta contable, naturaleza del movimiento, etc
        /// </summary>
        /// <param name="year"></param>
        /// <param name="month"></param>
        /// <param name="userId"></param>
        /// <param name="date"></param>
        /// <param name="isClosure"></param>
        /// <returns>int</returns>
        public int SaveProcessEntries(int year, int month, int userId, DateTime date, int isClosure)
        {
            int saved = 0;
            int rows;

            try
            {
                // Primero borro registros mayorizados anteriormente y que sean asientos automáticos.
                DeleteProcessEntries(year, month, 2);

                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(GetSummaryEntries.Properties.Date);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(new DateTime(year, month, 1));
                criteriaBuilder.And();
                criteriaBuilder.Property(GetSummaryEntries.Properties.Date);
                criteriaBuilder.LessEqual();
                if (isClosure == 1)
                {
                    criteriaBuilder.Constant(new DateTime(year, month, DaysMonth(year, month), 23, 59, 59));
                }
                else
                {
                    criteriaBuilder.Constant(DateTime.Now);
                }

                UIView accountingEntries = _dataFacadeManager.GetDataFacade().GetView("GetSummaryEntries", criteriaBuilder.GetPredicate(), null, 0, 2147483647, null, true, out rows);

                GeneralLedgerModels.LedgerEntry ledgerEntry = new GeneralLedgerModels.LedgerEntry();
                ledgerEntry.LedgerEntryItems = new List<GeneralLedgerModels.LedgerEntryItem>();

                if (accountingEntries.Count > 0)
                {
                    foreach (DataRow item in accountingEntries)
                    {
                        //Cabecera
                        ledgerEntry.AccountingCompany = new GeneralLedgerModels.AccountingCompany();
                        ledgerEntry.AccountingCompany.AccountingCompanyId = Convert.ToInt32(item["AccountingCompanyId"]);
                        ledgerEntry.AccountingDate = date;
                        ledgerEntry.AccountingMovementType = new GeneralLedgerModels.AccountingMovementType();
                        ledgerEntry.AccountingMovementType.AccountingMovementTypeId = Convert.ToInt32(ConfigurationManager.AppSettings["AutomaticEntries"]);
                        ledgerEntry.Branch = new CommonModels.Branch();
                        ledgerEntry.Branch.Id = Convert.ToInt32(item["BranchCode"]);
                        ledgerEntry.Description = "";
                        ledgerEntry.EntryDestination = new GeneralLedgerModels.EntryDestination();
                        ledgerEntry.EntryDestination.DestinationId = Convert.ToInt32(ConfigurationManager.AppSettings["EntryDestinationBoth"]);
                        ledgerEntry.Id = 0;
                        ledgerEntry.ModuleDateId = item["AccountingModuleId"] == DBNull.Value ? 0 : Convert.ToInt32(item["AccountingModuleId"]);
                        ledgerEntry.RegisterDate = DateTime.Now;
                        ledgerEntry.SalePoint = new CommonModels.SalePoint();
                        ledgerEntry.SalePoint.Id = Convert.ToInt32(item["SalePointCode"]);
                        ledgerEntry.UserId = userId;

                        //Detalle
                        GeneralLedgerModels.LedgerEntryItem ledgerEntryItem = new GeneralLedgerModels.LedgerEntryItem();
                        ledgerEntryItem.Id = 0;
                        ledgerEntryItem.AccountingAccount = new GeneralLedgerModels.AccountingAccount();
                        ledgerEntryItem.AccountingAccount.AccountingAccountId = Convert.ToInt32(item["AccountingAccountId"]);
                        ledgerEntryItem.AccountingNature = Convert.ToInt32(item["AccountingNature"]) == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Credit) ? GeneralLedgerModels.AccountingNatures.Credit : GeneralLedgerModels.AccountingNatures.Debit;

                        ledgerEntryItem.Amount = new CommonModels.Amount();
                        ledgerEntryItem.Amount.Value = Convert.ToDecimal(item["TotalAmountValue"]);
                        ledgerEntryItem.Amount.Currency = new CommonModels.Currency();
                        ledgerEntryItem.Amount.Currency.Id = Convert.ToInt32(item["CurrencyCode"]);
                        ledgerEntryItem.ExchangeRate = new CommonModels.ExchangeRate();
                        ledgerEntryItem.ExchangeRate.SellAmount = Convert.ToDecimal(item["ExchangeRate"]);
                        ledgerEntryItem.LocalAmount = new CommonModels.Amount();
                        ledgerEntryItem.LocalAmount.Value = Convert.ToDecimal(item["TotalAmountLocalValue"]);
                        ledgerEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        ledgerEntryItem.ReconciliationMovementType = new GeneralLedgerModels.ReconciliationMovementType();
                        ledgerEntryItem.ReconciliationMovementType.Id = 0;
                        ledgerEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        ledgerEntryItem.Currency = new CommonModels.Currency() { Id = Convert.ToInt32(item["CurrencyCode"]) };
                        ledgerEntryItem.Description = "MAYORIZACIÓN DEL MES " + Convert.ToString(month) + "/" + Convert.ToString(year);
                        ledgerEntryItem.Individual = new Individual() { IndividualId = Convert.ToInt32(item["IndividualId"]) };
                        ledgerEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();
                        ledgerEntryItem.Receipt = new GeneralLedgerModels.Receipt();
                        ledgerEntryItem.Receipt.Date = null;
                        ledgerEntryItem.Receipt.Number = 0;
                        ledgerEntry.LedgerEntryItems.Add(ledgerEntryItem);
                    }

                    saved = SaveLedgerEntry(ledgerEntry);
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return saved;
        }

        #endregion EntryPosting

        #region Reports

        #region EntryReport

        /// <summary>
        /// GetEntriesByDate
        /// Obtiene Asientos por fecha
        /// </summary>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="branchId"></param>
        /// <returns>List<EntryDTO></returns>
        public List<EntryDTO> GetEntriesByDate(DateTime dateFrom, DateTime dateTo, int branchId)
        {
            List<EntryDTO> entryDTOs = new List<EntryDTO>();

            var year = dateFrom.Year;
            var month = dateFrom.Month;
            var parameters = new NameValue[6];
            parameters[0] = new NameValue("START_YEAR", year);
            parameters[1] = new NameValue("START_MONTH", month);
            parameters[2] = new NameValue("START_DAY", dateFrom.Day);
            parameters[3] = new NameValue("YEAR", dateTo.Year);
            parameters[4] = new NameValue("MONTH", dateTo.Month);
            parameters[5] = new NameValue("DAY", dateTo.Day);

            DataTable result;
            using (DynamicDataAccess dynamicDataAccess = new DynamicDataAccess())
            {
                result = dynamicDataAccess.ExecuteSPDataTable("GL.GET_ENTRIES_DETAIL_PROCEDURE", parameters);
            }

            if (result != null && result.Rows.Count > 0)
            {
                foreach (DataRow arrayItem in result.Rows)
                {
                    EntryDTO dailyEntryDto = new EntryDTO();
                    dailyEntryDto.AccountingAccountDescription = Convert.ToString(EvalDetails(arrayItem[0], "-"));
                    dailyEntryDto.AccountingAccountId = Convert.ToDecimal(EvalDetails(arrayItem[1], "0"));
                    dailyEntryDto.AccountingCompanyDescription = Convert.ToString(EvalDetails(arrayItem[2], "-"));
                    dailyEntryDto.AccountingCompanyId = Convert.ToInt32(EvalDetails(arrayItem[3], "0"));
                    dailyEntryDto.AccountingNumber = Convert.ToDecimal(EvalDetails(arrayItem[4], "0"));
                    dailyEntryDto.AccountingModuleId = Convert.ToInt32(EvalDetails(arrayItem[5], "0"));
                    dailyEntryDto.AccountingMovementTypeDescription = Convert.ToString(EvalDetails(arrayItem[6], "-"));
                    dailyEntryDto.AccountingMovementTypeId = Convert.ToInt32(EvalDetails(arrayItem[7], "0"));
                    dailyEntryDto.AccountingNature = Convert.ToInt32(EvalDetails(arrayItem[8], "0"));
                    dailyEntryDto.AmountLocalValue = Convert.ToDecimal(EvalDetails(arrayItem[9], "0"));
                    dailyEntryDto.AmountValue = Convert.ToDecimal(EvalDetails(arrayItem[10], "0"));
                    dailyEntryDto.BankReconciliationDescription = Convert.ToString(EvalDetails(arrayItem[11], "-"));
                    dailyEntryDto.BankReconciliationId = Convert.ToInt32(EvalDetails(arrayItem[12], "0"));
                    dailyEntryDto.BranchCd = Convert.ToInt32(EvalDetails(arrayItem[13], "0"));
                    dailyEntryDto.CurrencyCd = Convert.ToInt32(EvalDetails(arrayItem[14], "0"));
                    dailyEntryDto.Date = Convert.ToDateTime(EvalDetails(arrayItem[15], "01/01/1900"));
                    dailyEntryDto.ReceiptDate = Convert.ToDateTime(EvalDetails(arrayItem[16], "01/01/1900"));
                    dailyEntryDto.ReceiptNumber = Convert.ToInt32(EvalDetails(arrayItem[17], "0"));
                    dailyEntryDto.Description = Convert.ToString(EvalDetails(arrayItem[18], "-"));
                    dailyEntryDto.EntryDestinationId = Convert.ToInt32(EvalDetails(arrayItem[19], "0"));
                    dailyEntryDto.EntryNumber = Convert.ToInt32(EvalDetails(arrayItem[20], "0"));
                    dailyEntryDto.ExchangeRate = Convert.ToDecimal(EvalDetails(arrayItem[21], "0"));
                    dailyEntryDto.IsDailyEntry = Convert.ToBoolean(EvalDetails(arrayItem[22], "0"));

                    dailyEntryDto.SalePointCd = Convert.ToInt32(EvalDetails(arrayItem[23], "0"));
                    dailyEntryDto.EntryId = Convert.ToInt32(EvalDetails(arrayItem[25], "0"));
                    dailyEntryDto.BranchDescription = Convert.ToString(EvalDetails(arrayItem[27], "-"));
                    dailyEntryDto.CurrencyDescription = Convert.ToString(EvalDetails(arrayItem[28], "-"));
                    entryDTOs.Add(dailyEntryDto);
                }
            }

            return entryDTOs;
        }

        #endregion


        /// <summary>
        /// GetDailyEntriesByRangeDateBranchId
        /// </summary>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="branchId"></param>
        /// <returns>List<EntryDTO></returns>
        public List<EntryDTO> GetDailyEntriesByRangeDateBranchId(DateTime dateFrom, DateTime dateTo, int branchId)
        {
            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.Property(GetDailyEntriesDetail.Properties.Dailyentryheaderdate);
            criteriaBuilder.GreaterEqual();
            criteriaBuilder.Constant(dateFrom);
            criteriaBuilder.And();
            criteriaBuilder.Property(GetDailyEntriesDetail.Properties.Dailyentryheaderdate);
            criteriaBuilder.LessEqual();
            criteriaBuilder.Constant(dateTo);

            if (branchId != 0)
            {
                criteriaBuilder.And();
                criteriaBuilder.Property(GetDailyEntriesDetail.Properties.Branchcd);
                criteriaBuilder.Equal();
                criteriaBuilder.Constant(branchId);
            }

            List<EntryDTO> entries = new List<EntryDTO>();

            BusinessCollection dailyEntries = new BusinessCollection(_dataFacadeManager.GetDataFacade().
                                              SelectObjects(typeof(GetDailyEntriesDetail),
                                              criteriaBuilder.GetPredicate()));
            if (dailyEntries.Count > 0)
            {
                foreach (GetDailyEntriesDetail item in dailyEntries.OfType<GetDailyEntriesDetail>())
                {
                    EntryDTO dailyEntryDto = new EntryDTO();
                    dailyEntryDto.DailyEntryId = item.Dailyentryid;
                    dailyEntryDto.AccountingAccountDescription = item.Accountingaccountname;
                    dailyEntryDto.AccountingAccountId = Convert.ToDecimal(item.Accountingaccountid);
                    dailyEntryDto.AccountingCompanyDescription = item.Accountingcompanydescription;
                    dailyEntryDto.AccountingCompanyId = Convert.ToInt32(item.Accountingcompanyid);
                    dailyEntryDto.AccountingNumber = Convert.ToDecimal(DBNull.ReferenceEquals(item.Accountingaccountnumber, DBNull.Value) ? 0 : Convert.ToDecimal(item.Accountingaccountnumber));
                    dailyEntryDto.AccountingNature = Convert.ToInt32(item.Accountingnature);
                    dailyEntryDto.AmountLocalValue = Convert.ToDecimal(item.Amountlocalvalue);
                    dailyEntryDto.AmountValue = Convert.ToDecimal(item.Amountvalue);
                    dailyEntryDto.BranchCd = Convert.ToInt32(item.Branchcd);
                    dailyEntryDto.BranchDescription = item.Branchdescription;     // Se aumenta para el reporte
                    dailyEntryDto.CurrencyDescription = item.Currencydescription; // Se aumenta para el reporte
                    dailyEntryDto.CurrencyCd = Convert.ToInt32(item.Currencycd);
                    dailyEntryDto.ReceiptDate = Convert.ToDateTime(item.Dailyentryheaderdate);
                    dailyEntryDto.ReceiptNumber = item.Receiptnumber;
                    dailyEntryDto.Description = item.Description;
                    dailyEntryDto.EntryNumber = Convert.ToInt32(item.Entrynumber);
                    dailyEntryDto.DailyEntryHeaderId = Convert.ToInt32(item.Dailyentryheaderid);
                    dailyEntryDto.TransactionNumber = Convert.ToInt32(item.Transactionnumber);
                    dailyEntryDto.ImputationCode = Convert.ToInt32(item.Originidentifycode);
                    dailyEntryDto.DailyEntryHeaderDescription = item.Dailyentryheaderdescription;
                    entries.Add(dailyEntryDto);
                }
            }
            return entries;
        }

        #endregion

        #region BalanceChecking

        /// <summary>
        /// GetBalanceCheckingDTO
        /// Obtiene el balance de cuentas
        /// </summary>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <returns>List<BalanceCheckingDTO></returns>
        public List<BalanceCheckingDTO> GetBalanceCheckingDTO(DateTime dateFrom, DateTime dateTo)
        {
            try
            {
                int rows;
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(Entry.Properties.Date);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(dateFrom);
                criteriaBuilder.And();
                criteriaBuilder.Property(Entry.Properties.Date);
                criteriaBuilder.LessEqual();
                criteriaBuilder.Constant(dateTo);

                UIView entries = _dataFacadeManager.GetDataFacade().GetView("ReportCheking", criteriaBuilder.GetPredicate(), null, 0, 300, null, true, out rows);

                var balances = from row in entries.AsEnumerable()
                               group row by
                               new
                               {
                                   Number = row.Field<string>("AccountNumber"),
                                   AccountName = row.Field<string>("AccountName"),
                               }
                                into g
                               select new
                               {
                                   AccountNumber = g.Key.Number,
                                   DescriptionAccount = g.Key.AccountName,
                                   SumDebit = g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Debit)).Sum(row => row.Field<decimal>("AmountValue")),
                                   SumCredit = g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Credit)).Sum(row => row.Field<decimal>("AmountValue")),
                                   Creditbalance = g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Credit)).Sum(row => row.Field<decimal>("AmountValue")) -
                                                                  g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Debit)).Sum(row => row.Field<decimal>("AmountValue")), //SALDO ACREEDOR
                                   Debitbalance = g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Debit)).Sum(row => row.Field<decimal>("AmountValue")) -
                                                                  g.Where(row => row.Field<int>("AccountingNature") == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Credit)).Sum(row => row.Field<decimal>("AmountValue")), //SALDO DEUDOR
                               };

                return balances.Select(data => new BalanceCheckingDTO
                {
                    AccountingAccount = data.AccountNumber,
                    DescriptionAccount = data.DescriptionAccount,
                    SumCredit = data.SumCredit,
                    SumDebit = data.SumDebit,
                    Creditbalance = data.Creditbalance,
                    Debitbalance = data.Debitbalance
                }).ToList();
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion BalanceCheking

        #region Closing

        /// <summary>
        /// IncomeOutcomeClosing
        /// Cierre de Ingresos y Egresos
        /// </summary>
        /// <param name="year"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int IncomeOutcomeClosing(int year, int userId)
        {
            ClosingDAO closingDAO = new ClosingDAO();
            return closingDAO.IncomeOutcomeClosing(year, userId);
        }

        /// <summary>
        /// MonthlyIncomeClosing
        /// Cierre de utilidad mensual - Cierre de Activo y Pasivo
        /// </summary>
        /// <param name="year"></param>
        /// <param name="userId"></param>
        /// <param name="month"></param>
        /// <returns>int</returns>
        public int MonthlyIncomeClosing(int year, int userId, int month)
        {
            ClosingDAO closingDAO = new ClosingDAO();
            return closingDAO.MonthlyIncomeClosing(year, userId, month);
        }

        /// <summary>
        /// AssetAndLiabilityOpening
        /// Asiento de Apertura de Activos y Pasivos
        /// </summary>
        /// <param name="year"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int AssetAndLiabilityOpening(int year, int userId)
        {
            ClosingDAO closingDAO = new ClosingDAO();
            return closingDAO.AssetAndLiabilityOpening(year, userId);
        }

        /// <summary>
        /// RevertAnualEntryOpening
        /// Revesión de Asiento Anual de Apertura
        /// </summary>
        /// <param name="year"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int RevertAnualEntryOpening(int year, int userId)
        {
            ClosingDAO closingDAO = new ClosingDAO();
            return closingDAO.RevertAnualEntryOpening(year, userId);
        }

        /// <summary>
        /// RevertIncomeOutcomeClosing
        /// Reversar Cierre Anual de Ingresos y Egresos
        /// </summary>
        /// <param name="year"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int RevertIncomeOutcomeClosing(int year, int userId)
        {
            ClosingDAO closingDAO = new ClosingDAO();
            return closingDAO.RevertIncomeOutcomeClosing(year, userId);
        }

        #endregion Closing

        #region EntryMassiveLoad

        /// <summary>
        /// SaveEntryMassiveLoadRequest 
        /// </summary>
        /// <param name="massiveEntryDTO"></param>
        /// <returns>bool</returns>
        public bool SaveEntryMassiveLoadRequest(MassiveEntryDTO massiveEntryDTO)
        {
            bool isSaved = false;

            try
            {
                EntryMassiveLoadDAO entryMassiveLoadDAO = new EntryMassiveLoadDAO();
                massiveEntryDTO = entryMassiveLoadDAO.SaveEntryMassiveLoad(massiveEntryDTO);
                isSaved = (massiveEntryDTO.Id > 0);
            }
            catch
            {
                isSaved = false;
            }

            return isSaved;
        }

        /// <summary>
        /// ClearEntryMassiveLoad
        /// </summary>
        public void ClearEntryMassiveLoad()
        {
            try
            {
                EntryMassiveLoadDAO entryMassiveLoadDAO = new EntryMassiveLoadDAO();
                List<MassiveEntryDTO> massiveEntries = entryMassiveLoadDAO.GetEntryMassiveLoads();

                if (massiveEntries.Count > 0)
                {
                    foreach (MassiveEntryDTO massiveEntryDTO in massiveEntries)
                    {
                        entryMassiveLoadDAO.DeleteEntryMassiveLoad(massiveEntryDTO.Id);
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// DisableEntryMassiveLoadLog
        /// Deshabilita todos los registros de la tabla de log de asientos masivos.
        /// </summary>
        public void DisableEntryMassiveLoadLog()
        {
            try
            {
                EntryMassiveLoadLogDAO entryMassiveLoadLogDAO = new EntryMassiveLoadLogDAO();
                // Se obiene todos los registros de la tabla de log
                List<MassiveEntryLogDTO> massiveEntryLogs = entryMassiveLoadLogDAO.GetEntryMassiveLoadLogs();

                if (massiveEntryLogs.Count > 0)
                {
                    foreach (MassiveEntryLogDTO massiveEntryLogDTO in massiveEntryLogs)
                    {
                        MassiveEntryLogDTO massiveEntryLogDtoNew = entryMassiveLoadLogDAO.GetEntryMassiveLoadLog(massiveEntryLogDTO);
                        massiveEntryLogDtoNew.Enabled = false;
                        entryMassiveLoadLogDAO.UpdateEntryMassiveLoadLog(massiveEntryLogDtoNew);
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// SaveEntryMassiveLoadLogRequest
        /// graba el regsitro en la tabla de log
        /// </summary>
        /// <param name="massiveEntryLogDTO"></param>
        /// <returns>MassiveEntryLogDTO</returns>
        public MassiveEntryLogDTO SaveEntryMassiveLoadLogRequest(MassiveEntryLogDTO massiveEntryLogDTO)
        {
            EntryMassiveLoadLogDAO entryMassiveLoadLogDAO = new EntryMassiveLoadLogDAO();
            return entryMassiveLoadLogDAO.SaveEntryMassiveLoadLog(massiveEntryLogDTO);
        }

        /// <summary>
        /// GetEntryMassiveLoadRecords
        /// Obtienes los totales del proceso masivo de asiento
        /// </summary>
        /// <returns>EntryMassiveLoadResultDTO</returns>
        public EntryMassiveLoadResultDTO GetEntryMassiveLoadRecords()
        {
            int totalRecords = 0;
            int successfulRecords = 0;
            int failedRecords = 0;
            EntryMassiveLoadResultDTO entryMassiveLoadResultDTO = new EntryMassiveLoadResultDTO();

            List<MassiveEntryLogDTO> massiveEntryLogs = new List<MassiveEntryLogDTO>();

            try
            {
                EntryMassiveLoadLogDAO entryMassiveLoadLogDAO = new EntryMassiveLoadLogDAO();
                // Total de movimientos procesados
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(EntryMassiveLoad.Properties.EntryMassiveLoadId);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(0);

                BusinessCollection totalCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(EntryMassiveLoad), criteriaBuilder.GetPredicate()));

                if (totalCollection.Count > 0)
                {
                    totalRecords = Convert.ToInt32(totalCollection.Count);
                }

                // Se obtiene los registros habilitados de la tabla de log.
                massiveEntryLogs = entryMassiveLoadLogDAO.GetEntryMassiveLoadLogs();

                if (massiveEntryLogs.Count > 0)
                {
                    var successQuery = from MassiveEntryLogDTO successMassiveEntryRecords in massiveEntryLogs where successMassiveEntryRecords.Enabled == Convert.ToBoolean(1) && successMassiveEntryRecords.Success == Convert.ToBoolean(1) select successMassiveEntryRecords;
                    if (successQuery.Any())
                    {
                        successfulRecords = Convert.ToInt32(successQuery.Count());
                    }

                    var failedQuery = from MassiveEntryLogDTO successMassiveEntryRecords in massiveEntryLogs where successMassiveEntryRecords.Enabled == Convert.ToBoolean(1) && successMassiveEntryRecords.Success == Convert.ToBoolean(0) select successMassiveEntryRecords;

                    if (failedQuery.Any())
                    {
                        failedRecords = Convert.ToInt32(failedQuery.Count());
                    }
                }

                entryMassiveLoadResultDTO.TotalRecords = totalRecords;
                entryMassiveLoadResultDTO.SuccessfulRecords = successfulRecords;
                entryMassiveLoadResultDTO.FailedRecords = failedRecords;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return entryMassiveLoadResultDTO;
        }

        /// <summary>
        /// GetMassiveEntryFailedRecords
        /// Obtiene el listado de registros fallidos para mostrarlo en pantalla
        /// </summary>
        /// <returns>List<MassiveEntryLogDTO></returns>
        public List<MassiveEntryLogDTO> GetMassiveEntryFailedRecords()
        {
            List<MassiveEntryLogDTO> massiveEntryLogs = new List<MassiveEntryLogDTO>();

            try
            {
                EntryMassiveLoadLogDAO entryMassiveLoadLogDAO = new EntryMassiveLoadLogDAO();
                ObjectCriteriaBuilder filter = new ObjectCriteriaBuilder();
                filter.PropertyEquals(EntryMassiveLoadLog.Properties.Enabled, 1);
                filter.And();
                filter.PropertyEquals(EntryMassiveLoadLog.Properties.Success, 0);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(EntryMassiveLoadLog), filter.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    foreach (EntryMassiveLoadLog entryMassiveLoadLogEntity in businessCollection.OfType<EntryMassiveLoadLog>())
                    {
                        MassiveEntryLogDTO massiveEntryLogDTO = new MassiveEntryLogDTO();
                        massiveEntryLogDTO.Id = entryMassiveLoadLogEntity.Id;
                        massiveEntryLogDTO = entryMassiveLoadLogDAO.GetEntryMassiveLoadLog(massiveEntryLogDTO);
                        massiveEntryLogs.Add(massiveEntryLogDTO);
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return massiveEntryLogs;
        }

        /// <summary>
        /// GenerateEntry
        /// Genera y graba el asiento desde carga masiva
        /// </summary>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int GenerateEntry(int userId)
        {
            int entryNumber = 0;

            try
            {
                EntryMassiveLoadDAO entryMassiveLoadDAO = new EntryMassiveLoadDAO();
                // Se obtiene los registros de la tabla de trabajo.
                List<MassiveEntryDTO> massiveEntries = entryMassiveLoadDAO.GetEntryMassiveLoads();

                // Se arma el asiento
                if (massiveEntries.Count > 0)
                {
                    GeneralLedgerModels.LedgerEntry ledgerEntry = GenerateLedgerEntryFromMassiveEntryList(massiveEntries, userId);
                    entryNumber = SaveLedgerEntry(ledgerEntry);

                    //Se elimina la data de la tabla de trabajo
                    ClearEntryMassiveLoad();
                }
            }
            catch (BusinessException ex)
            {
                if (ex.Message.Contains("BusinessException"))
                {
                    throw new BusinessException(ConfigurationManager.AppSettings["BusinessExceptionMsj"]);
                }

                throw new BusinessException(ConfigurationManager.AppSettings["UnhandledExceptionMsj"]);
            }

            return entryNumber;
        }

        /// <summary>
        /// Obtiene el listado de operadores
        /// </summary>
        /// <returns>List<OperatorDTO/></returns>
        public List<OperatorDTO> GetOperators()
        {
            OperatorDAO operatorDAO = new OperatorDAO();
            return operatorDAO.GetOperators();
        }

        #endregion EntryMassiveLoad

        #region TempEntry

        /// <summary>
        /// ClearTempAccountEntry
        /// la temporal de generación de asientos.
        /// </summary>
        public void ClearTempAccountEntry()
        {
            try
            {
                TempEntryGenerationDAO tempEntryGenerationDAO = new TempEntryGenerationDAO();
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(TempEntryGeneration.Properties.TempEntryGenerationId);
                criteriaBuilder.GreaterEqual();
                criteriaBuilder.Constant(0);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(TempEntryGeneration), criteriaBuilder.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    foreach (TempEntryGeneration tempEntryGeneration in businessCollection.OfType<TempEntryGeneration>())
                    {
                        tempEntryGenerationDAO.DeleteTempEntryGeneration(tempEntryGeneration.TempEntryGenerationId);
                    }
                }
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }
        }

        /// <summary>
        /// SaveTempEntryItem
        /// Graba los movimientos del asiento en una tabla temporal
        /// </summary>
        /// <param name="ledgerEntry"></param>
        /// <param name="transactionNumber"></param>
        /// <param name="isJournalEntry"></param>
        /// <param name="userId"></param>
        public void SaveTempEntryItem(GeneralLedgerModels.LedgerEntry ledgerEntry, int transactionNumber, bool isJournalEntry, int userId)
        {
            if (ledgerEntry.LedgerEntryItems.Count > 0)
            {
                foreach (GeneralLedgerModels.LedgerEntryItem ledgerEntryItem in ledgerEntry.LedgerEntryItems)
                {
                    TempEntryGenerationDAO tempEntryGenerationDAO = new TempEntryGenerationDAO();
                    tempEntryGenerationDAO.SaveTempEntryGeneration(ledgerEntry, ledgerEntryItem, transactionNumber, isJournalEntry, userId);
                }
            }
        }

        /// <summary>
        /// SaveTempEntry
        /// Método para generar el asiento en cierres.
        /// </summary>
        /// <param name="transactionNumber"></param>
        /// <param name="sourceId"></param>
        /// <param name="description"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int SaveTempEntry(int transactionNumber, int sourceId, string description, int userId)
        {
            // Se obtiene todos los movimientos por número de transacción.
            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.PropertyEquals(TempEntryGeneration.Properties.TransactionNumber, transactionNumber);

            BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(TempEntryGeneration), criteriaBuilder.GetPredicate()));

            int entryNumber = 0;

            // Si envía sourceId es asiento de diario
            if (sourceId == 0)
            {
                GeneralLedgerModels.LedgerEntry ledgerEntry = GenerateTempLedgerEntry(businessCollection, userId);
                entryNumber = SaveLedgerEntry(ledgerEntry);
            }
            else
            {
                GeneralLedgerModels.JournalEntry journalEntry = GenerateTempJournalEntry(businessCollection, description, userId, transactionNumber);
                entryNumber = SaveJournalEntry(journalEntry);
            }

            return entryNumber;
        }

        #endregion TempEntry

        #region AccountReclassification

        /// <summary>
        /// SaveAccountReclassification
        /// </summary>
        /// <param name="accountReclassification"></param>
        /// <returns>AccountReclassification</returns>
        public ReclassificationModels.AccountReclassification SaveAccountReclassification(ReclassificationModels.AccountReclassification accountReclassification)
        {
            AccountReclassificationDAO accountReclassificationDAO = new AccountReclassificationDAO();
            return accountReclassificationDAO.SaveAccountReclassification(accountReclassification);
        }

        /// <summary>
        /// UpdateAccountReclassification
        /// </summary>
        /// <param name="accountReclassification"></param>
        /// <returns>AccountReclassification</returns>
        public ReclassificationModels.AccountReclassification UpdateAccountReclassification(ReclassificationModels.AccountReclassification accountReclassification)
        {
            AccountReclassificationDAO accountReclassificationDAO = new AccountReclassificationDAO();
            return accountReclassificationDAO.UpdateAccountReclassification(accountReclassification);
        }

        /// <summary>
        /// DeleteAccountReclassification
        /// </summary>
        /// <param name="accountReclassification"></param>
        /// <returns></returns>
        public void DeleteAccountReclassification(ReclassificationModels.AccountReclassification accountReclassification)
        {
            AccountReclassificationDAO accountReclassificationDAO = new AccountReclassificationDAO();
            accountReclassificationDAO.DeleteAccountReclassification(accountReclassification);
        }

        /// <summary>
        /// GetAccountReclassification
        /// </summary>
        /// <param name="month"></param>
        /// <param name="year"></param>
        /// <returns>List<AccountReclassification/></returns>
        public List<ReclassificationModels.AccountReclassification> GetAccountReclassification(int month, int year)
        {
            AccountReclassificationDAO accountReclassificationDAO = new AccountReclassificationDAO();
            return accountReclassificationDAO.GetAccountReclassificationByMonthAndYear(month, year);
        }

        /// <summary>
        /// GenerateAccountReclassification
        /// </summary>
        /// <param name="month"></param>
        /// <param name="year"></param>
        /// <returns>int</returns>
        public int GenerateEntryReclassification(int month, int year)
        {
            using (Context.Current)
            {
                Transaction transaction = new Transaction();

                try
                {
                    EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
                    // Se elimina la reclasificación de cuentas contables por mes y año
                    entryReclassificationDAO.DeleteEntryReclassification(month, year);

                    DateTime dateFrom = new DateTime(year, 1, 1);
                    DateTime dateTo = new DateTime(year, month, DateTime.DaysInMonth(year, month), 23, 59, 59);

                    // Se obtiene la parametrización de reclasificación para el mes y año.
                    ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                    criteriaBuilder.PropertyEquals(Reclassification.Properties.ProcessMonth, month).And();
                    criteriaBuilder.PropertyEquals(Reclassification.Properties.ProcessYear, year);

                    GeneralLedgerModels.ProcessLog processLog = new GeneralLedgerModels.ProcessLog()
                    {
                        EndDate = new DateTime(1900, 1, 1),
                        Id = 0,
                        ProcessLogStatus = GeneralLedgerModels.ProcessLogStatus.Started,
                        StartDate = DateTime.Now,
                        UserId = 1,
                        Month = month,
                        Year = year,
                    };

                    int rows;
                    var newProcessLog = entryReclassificationDAO.SaveProcessLog(processLog);

                    BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(Reclassification), criteriaBuilder.GetPredicate()));

                    if (businessCollection.Count > 0)
                    {
                        foreach (Reclassification reclassificationEntity in businessCollection.OfType<Reclassification>())
                        {
                            // Se obtiene la moneda, centro de costo y sucursal 
                            criteriaBuilder = new ObjectCriteriaBuilder();
                            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
                            criteriaBuilder.GreaterEqual();
                            criteriaBuilder.Constant(dateFrom);
                            criteriaBuilder.And();
                            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
                            criteriaBuilder.LessEqual();
                            criteriaBuilder.Constant(dateTo);
                            criteriaBuilder.And();
                            criteriaBuilder.PropertyEquals(LedgerEntryItem.Properties.AccountingAccountId, reclassificationEntity.SourceAccountingAccountId);

                            UIView costCenterEntries = _dataFacadeManager.GetDataFacade().GetView("EntryCostCenter", criteriaBuilder.GetPredicate(), null, 0, 2147483647, null, true, out rows);

                            ProcessReclassificationCostCenters(costCenterEntries, dateFrom, dateTo, reclassificationEntity, month, year);
                        }
                    }

                    newProcessLog.ProcessLogStatus = GeneralLedgerModels.ProcessLogStatus.Finished;
                    entryReclassificationDAO.UpdateProcessLog(newProcessLog);

                    transaction.Complete();

                    return 1;
                }
                catch (BusinessException ex)
                {
                    transaction.Dispose();
                    throw new BusinessException(ex.Message);
                }
            }
        }

        /// <summary>
        /// SaveAccountReclassificationResult
        /// </summary>
        /// <param name="accountReclassificationResult"></param>
        /// <returns>AccountReclassificationResult</returns>
        public ReclassificationModels.AccountReclassificationResult SaveAccountReclassificationResult(ReclassificationModels.AccountReclassificationResult accountReclassificationResult)
        {
            EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
            return entryReclassificationDAO.SaveAccountReclassificationResult(accountReclassificationResult);
        }

        /// <summary>
        /// GetAccountReclassificationResult
        /// </summary>
        /// <param name="month"></param>
        /// <param name="year"></param>
        /// <returns>List<AccountReclassificationResult/></returns>
        public List<ReclassificationModels.AccountReclassificationResult> GetAccountReclassificationResults(int month, int year)
        {
            EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
            return entryReclassificationDAO.GetAccountingReclassificationByMonthAndYear(month, year);
        }

        #endregion AccountReclassification

        #region ProcessLog

        /// <summary>
        /// SaveProcessLog
        /// </summary>
        /// <param name="processLog"></param>
        /// <returns>ProcessLog</returns>
        public GeneralLedgerModels.ProcessLog SaveProcessLog(GeneralLedgerModels.ProcessLog processLog)
        {
            EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
            return entryReclassificationDAO.SaveProcessLog(processLog);
        }

        /// <summary>
        /// UpdateProcessLog
        /// </summary>
        /// <param name="processLog"></param>
        /// <returns>ProcessLog</returns>
        public GeneralLedgerModels.ProcessLog UpdateProcessLog(GeneralLedgerModels.ProcessLog processLog)
        {
            EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
            return entryReclassificationDAO.UpdateProcessLog(processLog);
        }

        /// <summary>
        /// GetProcessLog
        /// </summary>
        /// <param name="processLog"></param>
        /// <returns>ProcessLog</returns>
        public GeneralLedgerModels.ProcessLog GetProcessLog(GeneralLedgerModels.ProcessLog processLog)
        {
            EntryReclassificationDAO entryReclassificationDAO = new EntryReclassificationDAO();
            return entryReclassificationDAO.GetProcessLog(processLog);
        }

        #endregion ProcessLog

        #region AutomaticLedgerEntry

        /// <summary>
        /// SaveAutomaticLedgerEntry
        /// </summary>
        /// <param name="moduleDateId"></param>
        /// <param name="date"></param>
        /// <param name="userId"></param>
        /// <returns>int</returns>
        public int SaveAutomaticLedgerEntry(int moduleDateId, DateTime date, int userId)
        {
            AutomaticLedgerEntryDAO automaticLedgerEntryDAO = new AutomaticLedgerEntryDAO();
            return automaticLedgerEntryDAO.SaveAutomaticLedgerEntry(moduleDateId, date, userId);
        }

        #endregion

        #region Accounting

        /// <summary>
        /// Accounting
        /// </summary>
        /// <param name="moduleDateId"></param>
        /// <param name="parameters"></param>
        /// <param name="journalEntry"></param>
        /// <returns>int</returns>
        public int Accounting(int moduleDateId, List<List<GeneralLedgerModels.AccountingRules.Parameter>> parameters, GeneralLedgerModels.JournalEntry journalEntry)
        {
            int journalEntryId = 0;

            GeneralLedgerModels.JournalEntry newJournalEntry = journalEntry;

            //Listado de movimientos que se armarán con los valores obtenidos de la ejecución de reglas.
            List<GeneralLedgerModels.JournalEntryItem> newJournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();

            try
            {
                //la longitud de la lista de parámetros tiene que ser la misma de la longitud de detalles del asiento.
                for (int i = 0; i < journalEntry.JournalEntryItems.Count; i++)
                {
                    if (parameters[i].Count > 0)
                    {
                        //se realiza el cálculo de los movimientos.
                        List<GeneralLedgerModels.JournalEntryItem> entryItems = AssembleAccountingJournalEntryItems(journalEntry.JournalEntryItems[i], moduleDateId, parameters[i]);

                        if (entryItems.Count > 0)
                        {
                            foreach (var entryItem in entryItems)
                            {
                                newJournalEntryItems.Add(entryItem);
                            }
                        }
                    }
                    else
                    {
                        newJournalEntryItems.Add(journalEntry.JournalEntryItems[i]);
                    }
                }

                //se asigna los nuevos detalles generados al asiento.
                newJournalEntry.JournalEntryItems = newJournalEntryItems;

                //Valida débitos y créditos
                if (ValidateJournalEntryDebitsAndCredits(journalEntry.JournalEntryItems))
                {
                    journalEntryId = SaveJournalEntry(newJournalEntry);
                }
                else
                {
                    //asiento descuadrado
                    journalEntryId = 0;
                }
            }
            catch (BusinessException exception)
            {
                var message = exception.Message; //mensaje para revisión de errores

                //error en grabación de asiento.
                journalEntryId = -2;
            }

            return journalEntryId;
        }

        #endregion Accounting

        #endregion Public Methods

        #region Private Methods

        #region AccountingAccount

        /// <summary>
        /// Obtiene el nivel de la cuenta contable.
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>AccoutingAccountLevelDTO</returns>
        private AccoutingAccountLevelDTO GetAccountingAccountLevel(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            char[] accountNumber = accountingAccount.Number.Trim().ToCharArray();
            string subString = "";
            AccoutingAccountLevelDTO accountingAccountLevel = new AccoutingAccountLevelDTO();

            try
            {
                for (int i = accountNumber.Length - 1; i >= 1; i--)
                {
                    if (accountNumber[i] == '0')
                    {
                        subString = accountingAccount.Number.Substring(0, i);
                    }
                    else
                    {
                        break;
                    }
                }

                // Se obtiene los registros del nivel de la cuenta contable
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.Property(AccountingAccountLevel.Properties.Length);
                criteriaBuilder.Greater();
                criteriaBuilder.Constant(0);

                int length = subString == "" ? accountingAccount.Number.Trim().Length : subString.Length;

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AccountingAccountLevel), criteriaBuilder.GetPredicate()));

                var query = (from AccountingAccountLevel item in businessCollection where item.Length == length select item).ToList();

                int rows = query.Count;

                if (rows > 0)
                {
                    foreach (AccountingAccountLevel accountingAccountLevelEntity in query)
                    {
                        accountingAccountLevel.LevelCode = accountingAccountLevelEntity.LevelCode;
                        accountingAccountLevel.Description = accountingAccountLevelEntity.Description;
                        accountingAccountLevel.Length = Convert.ToInt32(accountingAccountLevelEntity.Length);
                    }
                }
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }

            return accountingAccountLevel;
        }

        /// <summary>
        /// ValidateAccountingAccountNumberNotExists
        /// </summary>
        /// <param name="accountNumber"></param>
        /// <returns>AccountingAccountValidationDTO</returns>
        private AccountingAccountValidationDTO ValidateAccountingAccountNumberDoesNotExist(string accountNumber)
        {
            AccountingAccountValidationDTO validationDTO = new AccountingAccountValidationDTO();
            validationDTO.TypeId = 1;

            GeneralLedgerModels.AccountingAccount accountingAccount = new GeneralLedgerModels.AccountingAccount() { Number = accountNumber };

            try
            {
                // Valida que el número de cuenta no exista
                List<GeneralLedgerModels.AccountingAccount> accountingAccounts = GetAccountingAccountsByNumberDescription(accountingAccount);

                validationDTO.IsSucessful = (accountingAccounts.Count <= 0);
            }
            catch (BusinessException)
            {
                validationDTO.IsSucessful = false;
            }

            return validationDTO;
        }

        /// <summary>
        /// ValidateAccountingAccountBaseNumber
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <param name="accountingAccountParentLevel"></param>
        /// <param name="accountingAccountLevel"></param>
        /// <param name="lengthLevel"></param>
        /// <returns>AccountingAccountValidationDTO</returns>
        private AccountingAccountValidationDTO ValidateAccountingAccountBaseNumber(GeneralLedgerModels.AccountingAccount accountingAccount, AccoutingAccountLevelDTO accountingAccountParentLevel, AccoutingAccountLevelDTO accountingAccountLevel, int lengthLevel)
        {
            AccountingAccountValidationDTO validationDTO = new AccountingAccountValidationDTO();
            GeneralLedgerModels.AccountingAccount parentAccount = new GeneralLedgerModels.AccountingAccount();

            if (lengthLevel > 2)
            {
                parentAccount.Number = accountingAccount.Number.Substring(0, lengthLevel - 2);
                accountingAccountParentLevel = GetAccountingAccountLevel(parentAccount);
            }

            if (accountingAccountLevel.LevelCode - accountingAccountParentLevel.LevelCode != 1)
            {
                validationDTO.TypeId = 2;
                validationDTO.IsSucessful = false;
            }
            else
            {
                validationDTO.IsSucessful = true;
            }

            return validationDTO;
        }

        /// <summary>
        /// AssembleParentAccountForValidation
        /// </summary>
        /// <param name="parentAccount"></param>
        /// <returns>AccountingAccount</returns>
        private GeneralLedgerModels.AccountingAccount AssembleParentAccountForValidation(GeneralLedgerModels.AccountingAccount parentAccount)
        {
            int branchStartPosition = 0;
            int prefixStartPosition = 0;

            if (parentAccount.Branch.Id != -1)
            {
                branchStartPosition = parentAccount.Number.Length - 2;
                parentAccount.Number = Convert.ToString(parentAccount.Number).Remove(branchStartPosition, 2);
                parentAccount.Number = parentAccount.Number.Insert(branchStartPosition, "00");
            }
            if (parentAccount.Prefixes.Count > 0)
            {
                prefixStartPosition = parentAccount.Number.Length - 4;
                parentAccount.Number = parentAccount.Number.Remove(prefixStartPosition, 2);
                parentAccount.Number = parentAccount.Number.Insert(prefixStartPosition, "00");
            }

            return parentAccount;
        }

        /// <summary>
        /// DeleteCostCentersByAccountingAccount
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>bool</returns>
        private bool DeleteCostCentersByAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            var isDeleted = false;

            try
            {
                AccountingAccountCostCenterDAO accountingAccountCostCenterDAO = new AccountingAccountCostCenterDAO();
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(Entities.AccountingAccountCostCenter.Properties.AccountingAccountId, accountingAccount.AccountingAccountId);

                // Asignamos BusinessCollection a una Lista
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(
                    typeof(Entities.AccountingAccountCostCenter), criteriaBuilder.GetPredicate()));

                // Return como objeto
                if (businessCollection.Count > 0)
                {
                    foreach (Entities.AccountingAccountCostCenter costCenters in businessCollection.OfType<Entities.AccountingAccountCostCenter>())
                    {
                        isDeleted = accountingAccountCostCenterDAO.DeleteAccountingAccountCostCenter(costCenters.AccountingAccountCostCenterId);
                    }
                }
                else
                {
                    isDeleted = true;
                }

                return isDeleted;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// DeletePrefixesByAccountingAccount
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>bool</returns>
        private bool DeletePrefixesByAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            var isDeleted = false;

            try
            {
                AccountingAccountPrefixDAO accountingAccountPrefixDAO = new AccountingAccountPrefixDAO();
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(Entities.AccountingAccountPrefix.Properties.AccountingAccountId, accountingAccount.AccountingAccountId);

                // Asignamos BusinessCollection a una Lista
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(
                    typeof(Entities.AccountingAccountPrefix), criteriaBuilder.GetPredicate()));

                // Return como objeto
                if (businessCollection.Count > 0)
                {
                    foreach (Entities.AccountingAccountPrefix prefixs in businessCollection.OfType<Entities.AccountingAccountPrefix>())
                    {
                        isDeleted = accountingAccountPrefixDAO.DeleteAccountingAccountPrefix(prefixs.AccountingAccountPrefixId);
                    }
                }
                else
                {
                    isDeleted = true;
                }

                return isDeleted;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetPrefixesByAccountingAccount
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>AccountingAccount</returns>
        private GeneralLedgerModels.AccountingAccount GetPrefixesByAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(Entities.AccountingAccountPrefix.Properties.AccountingAccountId, accountingAccount.AccountingAccountId);

                // Asignamos BusinessCollection a una Lista
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(
                    typeof(Entities.AccountingAccountPrefix), criteriaBuilder.GetPredicate()));

                if (accountingAccount.Prefixes == null)
                {
                    accountingAccount.Prefixes = new List<CommonModels.Prefix>();
                }

                if (businessCollection.Count > 0)
                {
                    foreach (Entities.AccountingAccountPrefix prefixs in businessCollection.OfType<Entities.AccountingAccountPrefix>())
                    {
                        accountingAccount.Prefixes.Add(new CommonModels.Prefix() { Id = Convert.ToInt32(prefixs.PrefixCode) });
                    }
                }

                return accountingAccount;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        /// <summary>
        /// GetCostCentersByAccountingAccount
        /// </summary>
        /// <param name="accountingAccount"></param>
        /// <returns>AccountingAccount</returns>
        private GeneralLedgerModels.AccountingAccount GetCostCentersByAccountingAccount(GeneralLedgerModels.AccountingAccount accountingAccount)
        {
            try
            {
                ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
                criteriaBuilder.PropertyEquals(Entities.AccountingAccountCostCenter.Properties.AccountingAccountId, accountingAccount.AccountingAccountId);

                // Asignamos BusinessCollection a una Lista
                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(
                    typeof(Entities.AccountingAccountCostCenter), criteriaBuilder.GetPredicate()));

                if (accountingAccount.CostCenters == null)
                {
                    accountingAccount.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                }

                if (businessCollection.Count > 0)
                {
                    foreach (Entities.AccountingAccountCostCenter costCenters in businessCollection.OfType<Entities.AccountingAccountCostCenter>())
                    {
                        accountingAccount.CostCenters.Add(new GeneralLedgerModels.CostCenter() { CostCenterId = Convert.ToInt32(costCenters.CostCenterId) });
                    }
                }

                return accountingAccount;
            }
            catch (BusinessException ex)
            {
                throw new BusinessException(ex.Message);
            }
        }

        #endregion AccountingAccount

        #region Entry

        /// <summary>
        /// EvalDetails
        /// Metodo Usado para reducir el Cognitivo detectado por SanarQube
        /// Agrupa funcionalidad individual en un Método para reutilizar. 
        /// </summary>
        /// <param name="valueObject"></param>
        /// <param name="typeResult"></param>
        /// <returns>object</returns>
        private object EvalDetails(object valueObject, string typeResult)
        {
            if (ReferenceEquals(valueObject, DBNull.Value))
            {
                return typeResult;
            }
            else
            {
                return valueObject;
            }
        }

        #endregion

        #region JournalEntry

        /// <summary>
        /// SaveItemGroup
        /// Método agrupa los guardar relacionados de JournalEntry 
        /// Centro de Costos, Analisis, PostDated
        /// </summary>
        /// <param name="journalEntryItem"></param>
        /// <param name="newJournalEntryItem"></param>
        private void SaveItemGroup(GeneralLedgerModels.JournalEntryItem journalEntryItem, GeneralLedgerModels.JournalEntryItem newJournalEntryItem)
        {
            AnalysisDAO analysisDAO = new AnalysisDAO();
            PostDatedDAO postDatedDAO = new PostDatedDAO();
            CostCenterEntryDAO costCenterEntryDAO = new CostCenterEntryDAO();
            if (journalEntryItem.CostCenters.Any())
            {
                foreach (GeneralLedgerModels.CostCenter costCenter in journalEntryItem.CostCenters)
                {
                    costCenterEntryDAO.SaveCostCenterEntry(costCenter, newJournalEntryItem.Id, true);
                }
            }

            if (journalEntryItem.Analysis.Any())
            {
                foreach (GeneralLedgerModels.Analysis analysis in journalEntryItem.Analysis)
                {
                    int correlativeNumber = GetCorrelativeNumber(analysis.AnalysisConcept.AnalysisCode.AnalysisCodeId, analysis.AnalysisConcept.AnalysisConceptId, analysis.Key) + 1;
                    analysisDAO.SaveAnalysis(analysis, newJournalEntryItem.Id, correlativeNumber, true);
                }
            }

            if (journalEntryItem.PostDated.Any())
            {
                foreach (GeneralLedgerModels.PostDated postDated in journalEntryItem.PostDated)
                {
                    postDatedDAO.SavePostDated(postDated, newJournalEntryItem.Id, true);
                }
            }
        }

        /// <summary>
        /// ValidateJournalEntryDebitsAndCredits
        /// </summary>
        /// <param name="journalEntryItems"></param>
        /// <returns>bool</returns>
        private bool ValidateJournalEntryDebitsAndCredits(List<GeneralLedgerModels.JournalEntryItem> journalEntryItems)
        {
            bool isValid = false;

            try
            {
                decimal debits = 0;
                decimal credits = 0;

                foreach (GeneralLedgerModels.JournalEntryItem journalEntryItem in journalEntryItems)
                {
                    if (journalEntryItem.AccountingNature == GeneralLedgerModels.AccountingNatures.Debit)
                    {
                        debits = debits + journalEntryItem.LocalAmount.Value;
                    }
                    else
                    {
                        credits = credits + journalEntryItem.LocalAmount.Value;
                    }
                }

                if ((System.Math.Abs(debits) > 0) && (System.Math.Abs(credits) > 0))
                {
                    isValid = (System.Math.Abs(debits) == System.Math.Abs(credits));
                }
            }
            catch (BusinessException)
            {
                isValid = false;
            }

            return isValid;
        }

        #endregion

        #region JournalEntryItems

        /// <summary>
        /// AssembleAccountingJournalEntryItems
        /// </summary>
        /// <param name="journalEntryItem"></param>
        /// <param name="moduleDateId"></param>
        /// <param name="parameters"></param>
        /// <returns>List<GeneralLedgerModels.JournalEntryItem></returns>
        private List<GeneralLedgerModels.JournalEntryItem> AssembleAccountingJournalEntryItems(GeneralLedgerModels.JournalEntryItem journalEntryItem, int moduleDateId, List<GeneralLedgerModels.AccountingRules.Parameter> parameters)
        {
            List<GeneralLedgerModels.JournalEntryItem> newJournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();

            try
            {
                EntryParameterApplicationServiceProvider _entryParameterService = new EntryParameterApplicationServiceProvider();
                List<GeneralLedgerModels.AccountingRules.Result> results = _entryParameterService.ExecuteAccountingRulePackage(moduleDateId, parameters);

                if (results.Count > 0)
                {
                    foreach (var result in results)
                    {
                        //Detalle
                        GeneralLedgerModels.JournalEntryItem newJournalEntryItem = new GeneralLedgerModels.JournalEntryItem();
                        newJournalEntryItem.AccountingAccount = new GeneralLedgerModels.AccountingAccount();
                        newJournalEntryItem.AccountingAccount.Number = result.AccountingAccount;
                        newJournalEntryItem.AccountingAccount = GetAccountingAccountsByNumberDescription(newJournalEntryItem.AccountingAccount).Count == 0 ?
                            new GeneralLedgerModels.AccountingAccount() : GetAccountingAccountsByNumberDescription(newJournalEntryItem.AccountingAccount)[0];
                        newJournalEntryItem.AccountingNature = result.AccountingNature;
                        newJournalEntryItem.Amount = new CommonModels.Amount();

                        newJournalEntryItem.Amount.Currency = journalEntryItem.Amount.Currency;
                        newJournalEntryItem.ExchangeRate = journalEntryItem.ExchangeRate;
                        newJournalEntryItem.ExchangeRate.SellAmount = journalEntryItem.ExchangeRate.SellAmount;
                        newJournalEntryItem.LocalAmount = new CommonModels.Amount();

                        if (journalEntryItem.Currency.Id == 0)//0 siempre moneda local
                        {
                            newJournalEntryItem.Amount.Value = Math.Abs(Convert.ToDecimal(result.Parameter.Value, CultureInfo.InvariantCulture));
                            newJournalEntryItem.LocalAmount.Value = Math.Abs(Convert.ToDecimal(result.Parameter.Value, CultureInfo.InvariantCulture)) * journalEntryItem.ExchangeRate.SellAmount;
                        }
                        else
                        {  //para poder obtener el IncomeAmount original 
                            newJournalEntryItem.Amount.Value = Math.Abs(Convert.ToDecimal(result.Parameter.Value, CultureInfo.InvariantCulture)) / journalEntryItem.ExchangeRate.SellAmount;
                            newJournalEntryItem.LocalAmount.Value = newJournalEntryItem.Amount.Value * journalEntryItem.ExchangeRate.SellAmount;
                        }

                        newJournalEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        newJournalEntryItem.ReconciliationMovementType = journalEntryItem.ReconciliationMovementType;
                        newJournalEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        newJournalEntryItem.Currency = journalEntryItem.Currency;
                        newJournalEntryItem.Description = journalEntryItem.Description;
                        newJournalEntryItem.EntryType = new GeneralLedgerModels.EntryType();
                        newJournalEntryItem.Id = 0;
                        newJournalEntryItem.Individual = journalEntryItem.Individual;
                        newJournalEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();
                        newJournalEntryItem.Receipt = journalEntryItem.Receipt;

                        newJournalEntryItems.Add(newJournalEntryItem);
                    }
                }

                return newJournalEntryItems;
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }
        }

        /// <summary>
        /// SetRevertionJournalEntryItems
        /// </summary>
        /// <param name="journalEntryId"></param>
        /// <returns>List<GeneralLedgerModels.JournalEntryItem></returns>
        private List<GeneralLedgerModels.JournalEntryItem> SetRevertionJournalEntryItems(int journalEntryId)
        {
            List<GeneralLedgerModels.JournalEntryItem> revertionJournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();

            try
            {
                JournalEntryItemDAO journalEntryItemDAO = new JournalEntryItemDAO();
                ObjectCriteriaBuilder journalEntryFilter = new ObjectCriteriaBuilder();
                journalEntryFilter.PropertyEquals(JournalEntryItem.Properties.JournalEntryId, journalEntryId);
                BusinessCollection journalEntryItems = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(JournalEntryItem), journalEntryFilter.GetPredicate()));

                if (journalEntryItems.Count > 0)
                {
                    foreach (JournalEntryItem journalEntryItemEntity in journalEntryItems.OfType<JournalEntryItem>())
                    {
                        GeneralLedgerModels.JournalEntryItem journalEntryItem = new GeneralLedgerModels.JournalEntryItem();
                        journalEntryItem.Id = journalEntryItemEntity.JournalEntryItemId;
                        journalEntryItem = journalEntryItemDAO.GetJournalEntryItem(journalEntryItem);
                        journalEntryItem.Id = 0; //se reinicia el identificador.
                        journalEntryItem.AccountingNature = (GeneralLedgerModels.AccountingNatures)journalEntryItemEntity.AccountingNature == GeneralLedgerModels.AccountingNatures.Credit ? GeneralLedgerModels.AccountingNatures.Debit : GeneralLedgerModels.AccountingNatures.Credit;
                        journalEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        journalEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        journalEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();

                        //se obtiene los centros de costos.
                        journalEntryItem.CostCenters = SetRevertionJournalEntryItemCostCenters(journalEntryItemEntity.JournalEntryItemId, true);

                        //se obtienen los análisis
                        journalEntryItem.Analysis = SetRevertionJournalEntryItemAnalyses(journalEntryItemEntity.JournalEntryItemId, true);

                        //se obtienen postfechados
                        journalEntryItem.PostDated = SetRevertionJournalEntryItemPostDated(journalEntryItemEntity.JournalEntryItemId, true);

                        revertionJournalEntryItems.Add(journalEntryItem);
                    }
                }
            }
            catch (BusinessException)
            {
                revertionJournalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();
            }

            return revertionJournalEntryItems;
        }

        /// <summary>
        /// SetRevertionJournalEntryItemCostCenters
        /// </summary>
        /// <param name="journalEntryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.CostCenter></returns>
        private List<GeneralLedgerModels.CostCenter> SetRevertionJournalEntryItemCostCenters(int journalEntryItemId, bool isJournalEntry)
        {
            List<GeneralLedgerModels.CostCenter> costCenters = GetCostCentersByEntryId(journalEntryItemId, isJournalEntry);

            if (costCenters.Count > 0)
            {
                foreach (GeneralLedgerModels.CostCenter costCenter in costCenters)
                {
                    costCenter.CostCenterId = 0;
                }
            }

            return costCenters;
        }

        /// <summary>
        /// SetRevertionJournalEntryItemAnalyses
        /// </summary>
        /// <param name="journalEntryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.Analysis></returns>
        private List<GeneralLedgerModels.Analysis> SetRevertionJournalEntryItemAnalyses(int journalEntryItemId, bool isJournalEntry)
        {
            List<GeneralLedgerModels.Analysis> analyses = GetAnalysesByEntryId(journalEntryItemId, isJournalEntry);

            if (analyses.Count > 0)
            {
                foreach (GeneralLedgerModels.Analysis analysis in analyses)
                {
                    analysis.AnalysisId = 0;
                }
            }

            return analyses;
        }

        /// <summary>
        /// SetRevertionJournalEntryItemPostDated
        /// </summary>
        /// <param name="journalEntryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.PostDated></returns>
        private List<GeneralLedgerModels.PostDated> SetRevertionJournalEntryItemPostDated(int journalEntryItemId, bool isJournalEntry)
        {
            List<GeneralLedgerModels.PostDated> postDateds = GetPostdatedByEntryId(journalEntryItemId, isJournalEntry);

            if (postDateds.Count > 0)
            {
                foreach (GeneralLedgerModels.PostDated postDated in postDateds)
                {
                    postDated.PostDatedId = 0;
                }
            }

            return postDateds;
        }

        #endregion JournalEntryItems

        #region TempEntry

        /// <summary>
        /// GenerateTempLedgerEntry
        /// </summary>
        /// <param name="businessCollection"></param>
        /// <param name="userId"></param>
        /// <returns>LedgerEntry</returns>
        private GeneralLedgerModels.LedgerEntry GenerateTempLedgerEntry(BusinessCollection businessCollection, int userId)
        {
            GeneralLedgerModels.LedgerEntry ledgerEntry = new GeneralLedgerModels.LedgerEntry();

            try
            {
                if (businessCollection.Count > 0)
                {
                    //Cabecera
                    ledgerEntry.AccountingCompany = new GeneralLedgerModels.AccountingCompany()
                    {
                        AccountingCompanyId = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().AccountingCompanyCode)
                    };
                    ledgerEntry.AccountingDate = Convert.ToDateTime(businessCollection.OfType<TempEntryGeneration>().First().Date);
                    ledgerEntry.AccountingMovementType = new GeneralLedgerModels.AccountingMovementType()
                    {
                        AccountingMovementTypeId = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().AccountingMovementTypeId)
                    };
                    ledgerEntry.Branch = new CommonModels.Branch() { Id = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().BranchCode) };
                    ledgerEntry.Description = businessCollection.OfType<TempEntryGeneration>().First().Description;
                    ledgerEntry.EntryDestination = new GeneralLedgerModels.EntryDestination()
                    {
                        DestinationId = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().EntryDestinationId)
                    };
                    ledgerEntry.EntryNumber = 0;
                    ledgerEntry.Id = 0;
                    ledgerEntry.ModuleDateId = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().AccountingModuleId);
                    ledgerEntry.RegisterDate = DateTime.Now;
                    ledgerEntry.SalePoint = new CommonModels.SalePoint() { Id = Convert.ToInt32(businessCollection.OfType<TempEntryGeneration>().First().SalePointCode) };// No existe este dato en ingreso de caja
                    ledgerEntry.Status = 1; //Activo
                    ledgerEntry.UserId = userId;
                    ledgerEntry.LedgerEntryItems = new List<GeneralLedgerModels.LedgerEntryItem>();

                    foreach (TempEntryGeneration tempEntryGeneration in businessCollection.OfType<TempEntryGeneration>())
                    {

                        //Detalle                       
                        GeneralLedgerModels.LedgerEntryItem ledgerEntryItem = new GeneralLedgerModels.LedgerEntryItem();
                        ledgerEntryItem.AccountingAccount = new GeneralLedgerModels.AccountingAccount()
                        {
                            AccountingAccountId = Convert.ToInt32(tempEntryGeneration.AccountingAccountId)
                        };
                        ledgerEntryItem.AccountingNature = (GeneralLedgerModels.AccountingNatures)tempEntryGeneration.AccountingNature;
                        ledgerEntryItem.Amount = new CommonModels.Amount();
                        ledgerEntryItem.Amount.Value = Convert.ToDecimal(tempEntryGeneration.Amount);
                        ledgerEntryItem.Amount.Currency = new CommonModels.Currency();
                        ledgerEntryItem.Amount.Currency.Id = Convert.ToInt32(tempEntryGeneration.CurrencyCode);
                        ledgerEntryItem.ExchangeRate = new CommonModels.ExchangeRate();
                        ledgerEntryItem.ExchangeRate.SellAmount = Convert.ToDecimal(tempEntryGeneration.ExchangeRate);
                        ledgerEntryItem.LocalAmount = new CommonModels.Amount();
                        ledgerEntryItem.LocalAmount.Value = Convert.ToDecimal(tempEntryGeneration.LocalAmount);
                        ledgerEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        ledgerEntryItem.ReconciliationMovementType = new GeneralLedgerModels.ReconciliationMovementType()
                        {
                            Id = Convert.ToInt32(tempEntryGeneration.BankReconciliationId)
                        };
                        ledgerEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        ledgerEntryItem.Currency = new CommonModels.Currency() { Id = Convert.ToInt32(tempEntryGeneration.CurrencyCode) };
                        ledgerEntryItem.Description = tempEntryGeneration.Description;
                        ledgerEntryItem.EntryType = new GeneralLedgerModels.EntryType();
                        ledgerEntryItem.Id = 0;
                        ledgerEntryItem.Individual = new Individual() { IndividualId = Convert.ToInt32(tempEntryGeneration.IndividualId) };
                        ledgerEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();
                        ledgerEntryItem.Receipt = new GeneralLedgerModels.Receipt()
                        {
                            Date = Convert.ToDateTime(tempEntryGeneration.ReceiptDate) == Convert.ToDateTime("01/01/0001 0:00:00") ? null :
                                                                                         tempEntryGeneration.ReceiptDate,
                            Number = Convert.ToInt32(tempEntryGeneration.ReceiptNumber)
                        };

                        ledgerEntry.LedgerEntryItems.Add(ledgerEntryItem);
                    }
                }
            }
            catch (BusinessException)
            {
                ledgerEntry = new GeneralLedgerModels.LedgerEntry();
            }

            return ledgerEntry;
        }

        /// <summary>
        /// GenerateTempJournalEntry
        /// </summary>
        /// <param name="businessCollection"></param>
        /// <param name="description"></param>
        /// <param name="userId"></param>
        /// <param name="transactionNumber"></param>
        /// <returns>JournalEntry</returns>
        private GeneralLedgerModels.JournalEntry GenerateTempJournalEntry(BusinessCollection businessCollection, string description, int userId, int transactionNumber)
        {
            GeneralLedgerModels.JournalEntry journalEntry = new GeneralLedgerModels.JournalEntry();

            try
            {
                if (businessCollection.Count > 0)
                {
                    foreach (TempEntryGeneration tempEntryGeneration in businessCollection.OfType<TempEntryGeneration>())
                    {
                        //Cabecera
                        journalEntry.AccountingCompany = new GeneralLedgerModels.AccountingCompany()
                        {
                            AccountingCompanyId = Convert.ToInt32(tempEntryGeneration.AccountingCompanyCode)
                        };
                        journalEntry.AccountingDate = Convert.ToDateTime(tempEntryGeneration.Date);
                        journalEntry.AccountingMovementType = new GeneralLedgerModels.AccountingMovementType()
                        {
                            AccountingMovementTypeId = Convert.ToInt32(tempEntryGeneration.AccountingMovementTypeId)
                        };
                        journalEntry.Branch = new CommonModels.Branch() { Id = Convert.ToInt32(tempEntryGeneration.BranchCode) };
                        journalEntry.Description = description;
                        journalEntry.EntryNumber = transactionNumber;
                        journalEntry.Id = 0;

                        //Detalle
                        List<GeneralLedgerModels.JournalEntryItem> journalEntryItems = new List<GeneralLedgerModels.JournalEntryItem>();
                        GeneralLedgerModels.JournalEntryItem journalEntryItem = new GeneralLedgerModels.JournalEntryItem();
                        journalEntryItem.AccountingAccount = new GeneralLedgerModels.AccountingAccount()
                        {
                            AccountingAccountId = Convert.ToInt32(tempEntryGeneration.AccountingAccountId)
                        };
                        journalEntryItem.AccountingNature = (GeneralLedgerModels.AccountingNatures)tempEntryGeneration.AccountingNature;
                        journalEntryItem.Amount = new CommonModels.Amount();
                        journalEntryItem.Amount.Value = Convert.ToDecimal(tempEntryGeneration.Amount);
                        journalEntryItem.Amount.Currency = new CommonModels.Currency();
                        journalEntryItem.Amount.Currency.Id = Convert.ToInt32(tempEntryGeneration.CurrencyCode);
                        journalEntryItem.ExchangeRate = new CommonModels.ExchangeRate();
                        journalEntryItem.ExchangeRate.SellAmount = Convert.ToDecimal(tempEntryGeneration.ExchangeRate);
                        journalEntryItem.LocalAmount = new CommonModels.Amount();
                        journalEntryItem.LocalAmount.Value = Convert.ToDecimal(tempEntryGeneration.LocalAmount);
                        journalEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                        journalEntryItem.ReconciliationMovementType = new GeneralLedgerModels.ReconciliationMovementType()
                        {
                            Id = Convert.ToInt32(tempEntryGeneration.BankReconciliationId)
                        };
                        journalEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                        journalEntryItem.Currency = new CommonModels.Currency() { Id = Convert.ToInt32(tempEntryGeneration.CurrencyCode) };
                        journalEntryItem.Description = description;
                        journalEntryItem.EntryType = new GeneralLedgerModels.EntryType();
                        journalEntryItem.Id = 0;
                        journalEntryItem.Individual = new Individual() { IndividualId = Convert.ToInt32(tempEntryGeneration.IndividualId) };
                        journalEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();
                        journalEntryItem.Receipt = new GeneralLedgerModels.Receipt()
                        {
                            Date = Convert.ToDateTime(tempEntryGeneration.ReceiptDate) == Convert.ToDateTime("01/01/0001 0:00:00") ? null :
                                                                                         tempEntryGeneration.ReceiptDate,
                            Number = Convert.ToInt32(tempEntryGeneration.ReceiptNumber)
                        };
                        journalEntryItems.Add(journalEntryItem);

                        journalEntry.JournalEntryItems = journalEntryItems;
                        journalEntry.ModuleDateId = Convert.ToInt32(tempEntryGeneration.AccountingModuleId);
                        journalEntry.RegisterDate = DateTime.Now;
                        journalEntry.SalePoint = new CommonModels.SalePoint() { Id = Convert.ToInt32(tempEntryGeneration.SalePointCode) };// No existe este dato en ingreso de caja
                        journalEntry.Status = 1; //Activo
                        journalEntry.UserId = userId;
                    }
                }
            }
            catch (BusinessException)
            {
                journalEntry = new GeneralLedgerModels.JournalEntry();
            }

            return journalEntry;
        }

        #endregion TempEntry

        #region EntryMassiveLoad

        /// <summary>
        /// GenerateLedgerEntryFromMassiveEntry
        /// </summary>
        /// <param name="massiveEntries"></param>
        /// <returns>LedgerEntry</returns>
        private GeneralLedgerModels.LedgerEntry GenerateLedgerEntryFromMassiveEntryList(List<MassiveEntryDTO> massiveEntries, int userId)
        {
            GeneralLedgerModels.LedgerEntry ledgerEntry = new GeneralLedgerModels.LedgerEntry();

            try
            {
                //Se obtienen los datos de la cabecera.
                List<MassiveEntryDTO> headerLedgerEntryGroup = massiveEntries.GroupBy(p => new { p.BranchId, p.SalePointId, p.AccoutingCompanyId, p.EntryDestinationId, p.AccountingMovementTypeId, p.OperationDate }).Select(g => g.First()).ToList();

                if (headerLedgerEntryGroup.Count > 0)
                {
                    ledgerEntry.AccountingCompany = new GeneralLedgerModels.AccountingCompany();
                    ledgerEntry.AccountingCompany.AccountingCompanyId = headerLedgerEntryGroup[0].AccoutingCompanyId;
                    ledgerEntry.AccountingDate = headerLedgerEntryGroup[0].OperationDate;
                    ledgerEntry.AccountingMovementType = new GeneralLedgerModels.AccountingMovementType();
                    ledgerEntry.AccountingMovementType.AccountingMovementTypeId = headerLedgerEntryGroup[0].AccountingMovementTypeId;
                    ledgerEntry.Branch = new CommonModels.Branch();
                    ledgerEntry.Branch.Id = Convert.ToInt32(headerLedgerEntryGroup[0].BranchId);
                    ledgerEntry.Description = "CARGA MASIVA SUCURSAL " + Convert.ToString(headerLedgerEntryGroup[0].BranchId) + ", FECHA " + Convert.ToString(headerLedgerEntryGroup[0].OperationDate);
                    ledgerEntry.EntryDestination = new GeneralLedgerModels.EntryDestination();
                    ledgerEntry.EntryDestination.DestinationId = headerLedgerEntryGroup[0].EntryDestinationId;
                    ledgerEntry.EntryNumber = 0;
                    ledgerEntry.Id = 0;
                    ledgerEntry.ModuleDateId = Convert.ToInt32(ConfigurationManager.AppSettings["LedgerEntryModule"]);
                    ledgerEntry.RegisterDate = DateTime.Now;
                    ledgerEntry.SalePoint = new CommonModels.SalePoint();
                    ledgerEntry.SalePoint.Id = headerLedgerEntryGroup[0].SalePointId;
                    ledgerEntry.UserId = userId;
                }

                //se generan los movimientos
                ledgerEntry.LedgerEntryItems = new List<GeneralLedgerModels.LedgerEntryItem>();

                foreach (MassiveEntryDTO massiveEntryDTO in massiveEntries)
                {
                    GeneralLedgerModels.LedgerEntryItem ledgerEntryItem = new GeneralLedgerModels.LedgerEntryItem();
                    ledgerEntryItem.CostCenters = new List<GeneralLedgerModels.CostCenter>();
                    ledgerEntryItem.Analysis = new List<GeneralLedgerModels.Analysis>();
                    ledgerEntryItem.PostDated = new List<GeneralLedgerModels.PostDated>();

                    ledgerEntryItem.AccountingAccount = new GeneralLedgerModels.AccountingAccount();
                    ledgerEntryItem.AccountingAccount.AccountingAccountId = Convert.ToInt32(massiveEntryDTO.AccountingAccountId);
                    ledgerEntryItem.AccountingNature = Convert.ToInt32(massiveEntryDTO.AccountingNature) == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Credit) ? GeneralLedgerModels.AccountingNatures.Credit : GeneralLedgerModels.AccountingNatures.Debit;

                    ledgerEntryItem.Amount = new CommonModels.Amount();
                    ledgerEntryItem.Amount.Value = Convert.ToDecimal(massiveEntryDTO.Amount);
                    ledgerEntryItem.Amount.Currency = new CommonModels.Currency();
                    ledgerEntryItem.Amount.Currency.Id = Convert.ToInt32(massiveEntryDTO.CurrencyId);
                    ledgerEntryItem.ExchangeRate = new CommonModels.ExchangeRate();
                    ledgerEntryItem.ExchangeRate.SellAmount = Convert.ToDecimal(massiveEntryDTO.ExchangeRate);
                    ledgerEntryItem.LocalAmount = new CommonModels.Amount();
                    ledgerEntryItem.LocalAmount.Value = Convert.ToDecimal(massiveEntryDTO.Amount * massiveEntryDTO.ExchangeRate);

                    ledgerEntryItem.ReconciliationMovementType = new GeneralLedgerModels.ReconciliationMovementType()
                    {
                        Id = Convert.ToInt32(massiveEntryDTO.BankReconciliationId)
                    };

                    ledgerEntryItem.Currency = new CommonModels.Currency() { Id = Convert.ToInt32(massiveEntryDTO.CurrencyId) };
                    ledgerEntryItem.Description = massiveEntryDTO.Description;
                    ledgerEntryItem.Id = 0;
                    ledgerEntryItem.Individual = new Individual() { IndividualId = massiveEntryDTO.IndividualId };

                    ledgerEntryItem.Receipt = new GeneralLedgerModels.Receipt()
                    {
                        Date = Convert.ToDateTime(massiveEntryDTO.ReceiptDate),
                        Number = massiveEntryDTO.ReceiptNumber
                    };

                    //centros de costos
                    if (massiveEntryDTO.CostCenterId > 0)
                    {
                        GeneralLedgerModels.CostCenter costCenter = new GeneralLedgerModels.CostCenter()
                        {
                            CostCenterId = Convert.ToInt32(massiveEntryDTO.CostCenterId),
                            PercentageAmount = Convert.ToDecimal(massiveEntryDTO.Percentage)
                        };

                        ledgerEntryItem.CostCenters.Add(costCenter);
                    }

                    //analisis
                    if (massiveEntryDTO.AnalysisId > 0)
                    {
                        GeneralLedgerModels.AnalysisConcept analysisConcept = new GeneralLedgerModels.AnalysisConcept();
                        analysisConcept.AnalysisConceptId = Convert.ToInt32(massiveEntryDTO.ConceptId);
                        analysisConcept.AnalysisCode = new GeneralLedgerModels.AnalysisCode();
                        analysisConcept.AnalysisCode.AnalysisCodeId = Convert.ToInt32(massiveEntryDTO.AnalysisId);

                        GeneralLedgerModels.Analysis analysis = new GeneralLedgerModels.Analysis();
                        analysis.AnalysisId = Convert.ToInt32(massiveEntryDTO.AnalysisId);
                        analysis.AnalysisConcept = analysisConcept;
                        analysis.Key = massiveEntryDTO.ConceptKey;
                        analysis.Description = massiveEntryDTO.AnalysisDescription;

                        ledgerEntryItem.Analysis.Add(analysis);
                    }

                    //postfechados
                    if (massiveEntryDTO.PostdatedId > 0)
                    {
                        CommonModels.Amount postDatedAmount = new CommonModels.Amount();
                        postDatedAmount.Value = Convert.ToDecimal(massiveEntryDTO.PostdatedAmount);
                        postDatedAmount.Currency = new CommonModels.Currency() { Id = Convert.ToInt32(massiveEntryDTO.PostdatedCurrencyId) };
                        decimal postDatedExchangeRate = Convert.ToDecimal(massiveEntryDTO.PostdatedExchangeRate);
                        CommonModels.ExchangeRate exchangeRate = new CommonModels.ExchangeRate() { SellAmount = postDatedExchangeRate };
                        CommonModels.Amount localAmount = new CommonModels.Amount() { Value = Convert.ToDecimal(massiveEntryDTO.PostdatedAmount) * postDatedExchangeRate };

                        GeneralLedgerModels.PostDated postDated = new GeneralLedgerModels.PostDated();
                        postDated.PostDatedId = 0; //autonumérico
                        postDated.PostDateType = (PostDateTypes)massiveEntryDTO.PostdatedId;
                        postDated.Amount = postDatedAmount;
                        postDated.DocumentNumber = Convert.ToInt32(massiveEntryDTO.PosdatedDocumentNumber);
                        postDated.ExchangeRate = exchangeRate;
                        postDated.LocalAmount = localAmount;

                        ledgerEntryItem.PostDated.Add(postDated);
                    }

                    ledgerEntry.LedgerEntryItems.Add(ledgerEntryItem);
                }
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return ledgerEntry;
        }

        #endregion EntryMassiveLoad

        #region Analysis

        /// <summary>
        /// GetAnalysesByEntryId
        /// </summary>
        /// <param name="entryItemId"></param>
        /// <param name="isJournalEntry"></param>
        /// <returns>List<GeneralLedgerModels.Analysis></returns>
        private List<GeneralLedgerModels.Analysis> GetAnalysesByEntryId(int entryItemId, bool isJournalEntry)
        {
            AnalysisDAO analysisDAO = new AnalysisDAO();
            List<GeneralLedgerModels.Analysis> analyses = new List<GeneralLedgerModels.Analysis>();

            try
            {
                ObjectCriteriaBuilder filter = new ObjectCriteriaBuilder();
                filter.PropertyEquals(AnalysisEntryItem.Properties.EntryItemId, entryItemId);
                filter.And();
                filter.PropertyEquals(AnalysisEntryItem.Properties.IsJournalEntry, isJournalEntry);

                BusinessCollection businessCollection = new BusinessCollection(_dataFacadeManager.GetDataFacade().SelectObjects(typeof(AnalysisEntryItem), filter.GetPredicate()));

                if (businessCollection.Count > 0)
                {
                    foreach (AnalysisEntryItem analysisEntryItemEntity in businessCollection.OfType<AnalysisEntryItem>())
                    {
                        GeneralLedgerModels.Analysis analysis = analysisDAO.GetAnalysis(Convert.ToInt32(analysisEntryItemEntity.AnalysisEntryItemId));
                        analyses.Add(analysis);
                    }
                }
            }
            catch (BusinessException exception)
            {
                throw new BusinessException(exception.Message);
            }

            return analyses;
        }

        #endregion Analysis

        #region AccountReclassification

        /// <summary>
        /// SaveAccountingReclassification
        /// </summary>
        /// <param name="accountReclassificationResult"></param>
        private void SaveAccountingReclassification(ReclassificationModels.AccountReclassificationResult accountReclassificationResult)
        {
            // Se inserta la entidad
            AccountingReclassification accountingReclassificationEntity = EntityAssembler.CreateAccountingReclassification(accountReclassificationResult);

            // Realizar las operaciones con los entities utilizando DAF
            _dataFacadeManager.GetDataFacade().InsertObject(accountingReclassificationEntity);
        }

        /// <summary>
        /// ProcessReclassificationCostCenters
        /// </summary>
        /// <param name="costCenterEntries"></param>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="reclassificationEntity"></param>
        /// <param name="month"></param>
        /// <param name="year"></param>
        private void ProcessReclassificationCostCenters(UIView costCenterEntries, DateTime dateFrom, DateTime dateTo, Reclassification reclassificationEntity, int month, int year)
        {
            if (costCenterEntries.Count > 0)
            {
                var costCenters = costCenterEntries.AsEnumerable()
                                    .GroupBy(r => new { Col1 = r["CurrencyCode"], Col2 = r["CostCenterId"], Col3 = r["BranchCode"] })
                                    .Select(g => g.OrderBy(r => r["AccountingAccountId"]).First())
                                    .CopyToDataTable();

                foreach (DataRow item in costCenters.Rows)
                {
                    /////////////////////////////////////
                    //// Sin analíticos                //
                    /////////////////////////////////////
                    GenerateEntriesWithoutAnalytical(item, dateFrom, dateTo, reclassificationEntity, month, year);

                    ///////////////////////////////////
                    // Con analíticos                //
                    ///////////////////////////////////
                    GenerateEntriesWithAnalytical(item, dateFrom, dateTo, reclassificationEntity, month, year);
                }
            }
        }

        /// <summary>
        /// GenerateEntriesWithoutAnalytical
        /// </summary>
        /// <param name="item"></param>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="reclassificationEntity"></param>
        /// <param name="month"></param>
        /// <param name="year"></param>
        private void GenerateEntriesWithoutAnalytical(DataRow item, DateTime dateFrom, DateTime dateTo, Reclassification reclassificationEntity, int month, int year)
        {
            int rows;

            int branchId = Convert.ToInt32(item["BranchCode"]);
            int costCenterId = item["CostCenterId"] == DBNull.Value ? -1 : Convert.ToInt32(item["CostCenterId"]);
            int currencyId = Convert.ToInt32(item["CurrencyCode"]);

            #region filter

            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
            criteriaBuilder.GreaterEqual();
            criteriaBuilder.Constant(dateFrom);
            criteriaBuilder.And();
            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
            criteriaBuilder.LessEqual();
            criteriaBuilder.Constant(dateTo);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntryItem.Properties.AccountingAccountId, reclassificationEntity.SourceAccountingAccountId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntry.Properties.BranchCode, branchId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntryItem.Properties.CurrencyCode, currencyId);
            if (costCenterId > 0)
            {
                criteriaBuilder.And();
                criteriaBuilder.PropertyEquals(CostCenterEntryItem.Properties.CostCenterId, costCenterId);
            }

            #endregion filter

            UIView analyticalEntries = _dataFacadeManager.GetDataFacade().GetView("EntryWithoutAnalytical", criteriaBuilder.GetPredicate(), null, 0, 2147483647, null, true, out rows);

            GenerateReclassificationEntries(analyticalEntries, currencyId, branchId, costCenterId, reclassificationEntity, month, year);
        }

        /// <summary>
        /// GenerateEntriesWithAnalytical
        /// </summary>
        /// <param name="item"></param>
        /// <param name="dateFrom"></param>
        /// <param name="dateTo"></param>
        /// <param name="reclassificationEntity"></param>
        /// <param name="month"></param>
        /// <param name="year"></param>
        private void GenerateEntriesWithAnalytical(DataRow item, DateTime dateFrom, DateTime dateTo, Reclassification reclassificationEntity, int month, int year)
        {
            int rows;

            int branchId = Convert.ToInt32(item["BranchCode"]);
            int costCenterId = item["CostCenterId"] == DBNull.Value ? -1 : Convert.ToInt32(item["CostCenterId"]);
            int currencyId = Convert.ToInt32(item["CurrencyCode"]);

            #region filter

            ObjectCriteriaBuilder criteriaBuilder = new ObjectCriteriaBuilder();
            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
            criteriaBuilder.GreaterEqual();
            criteriaBuilder.Constant(dateFrom);
            criteriaBuilder.And();
            criteriaBuilder.Property(LedgerEntry.Properties.AccountingDate);
            criteriaBuilder.LessEqual();
            criteriaBuilder.Constant(dateTo);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntryItem.Properties.AccountingAccountId, reclassificationEntity.SourceAccountingAccountId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntry.Properties.BranchCode, branchId);
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntryItem.Properties.CurrencyCode, currencyId);
            if (costCenterId > 0)
            {
                criteriaBuilder.And();
                criteriaBuilder.PropertyEquals(CostCenterEntryItem.Properties.CostCenterId, costCenterId);
            }
            criteriaBuilder.And();
            criteriaBuilder.PropertyEquals(LedgerEntry.Properties.AccountingMovementTypeId, 2);

            #endregion filter

            UIView analyticalEntries = _dataFacadeManager.GetDataFacade().GetView("EntryWithAnalytical", criteriaBuilder.GetPredicate(), null, 0, 2147483647, null, true, out rows);

            GenerateReclassificationEntries(analyticalEntries, currencyId, branchId, costCenterId, reclassificationEntity, month, year);
        }

        /// <summary>
        /// GenerateReclassificationEntries
        /// </summary>
        /// <param name="analyticalEntries"></param>
        /// <param name="currencyId"></param>
        /// <param name="branchId"></param>
        /// <param name="costCenterId"></param>
        /// <param name="reclassificationEntity"></param>
        /// <param name="month"></param>
        /// <param name="year"></param>
        private void GenerateReclassificationEntries(UIView analyticalEntries, int currencyId, int branchId, int costCenterId, Reclassification reclassificationEntity, int month, int year)
        {
            decimal incomeAmount = 0;
            decimal amount = 0;
            decimal incomeAmountDebit = 0;
            decimal amountDebit = 0;
            decimal exchangeRate = 0;
            int accountingAccountId = 0;
            int accountingReclassificationId = 0;
            int analysisId = 0;
            int analysisConceptId = 0;
            int sourceAccountingAccountId = 0;
            string conceptKey = "";

            if (analyticalEntries.Count > 0)
            {
                incomeAmount = GetReclassificationEntriesIncomeAmount(analyticalEntries);
                amount = GetReclassificationEntriesAmount(analyticalEntries);

                exchangeRate = Convert.ToDecimal(analyticalEntries.Rows[0]["ExchangeRate"]);
                accountingAccountId = Convert.ToInt32(analyticalEntries.Rows[0]["AccountingAccountId"]);
                analysisId = analyticalEntries.Rows[0]["AnalysisId"] == DBNull.Value ? -1 : Convert.ToInt32(analyticalEntries.Rows[0]["AnalysisId"]);
                analysisConceptId = analyticalEntries.Rows[0]["AnalysisConceptId"] == DBNull.Value ? -1 : Convert.ToInt32(analyticalEntries.Rows[0]["AnalysisConceptId"]);
                sourceAccountingAccountId = Convert.ToInt32(analyticalEntries.Rows[0]["AccountingAccountId"]);
                conceptKey = analyticalEntries.Rows[0]["ConceptKey"] == DBNull.Value ? "" : Convert.ToString(analyticalEntries.Rows[0]["ConceptKey"]);

                incomeAmountDebit = incomeAmount * -1;
                amountDebit = amount * -1;

                ///////////////////////////////////////
                // Crédito                           //
                ///////////////////////////////////////
                if (incomeAmount > 0)
                {
                    ReclassificationModels.AccountReclassificationResult accountReclassificationResult = new ReclassificationModels.AccountReclassificationResult();

                    accountReclassificationResult.AccountingNature = GeneralLedgerModels.AccountingNatures.Credit;
                    accountReclassificationResult.Amount = new CommonModels.Amount()
                    {
                        Currency = new CommonModels.Currency()
                        {
                            Id = currencyId
                        },
                        Value = incomeAmount
                    };
                    accountReclassificationResult.ExchangeRate = new CommonModels.ExchangeRate()
                    {
                        SellAmount = exchangeRate
                    };
                    accountReclassificationResult.LocalAmount = new CommonModels.Amount()
                    {
                        Value = amount
                    };
                    accountReclassificationResult.Analysis = new GeneralLedgerModels.Analysis()
                    {
                        AnalysisConcept = new GeneralLedgerModels.AnalysisConcept()
                        {
                            AnalysisConceptId = analysisConceptId
                        },
                        AnalysisId = analysisId,
                        Key = conceptKey
                    };

                    accountReclassificationResult.Branch = new CommonModels.Branch() { Id = branchId };
                    accountReclassificationResult.CostCenter = new GeneralLedgerModels.CostCenter()
                    {
                        CostCenterId = costCenterId
                    };
                    accountReclassificationResult.DestinationAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = accountingAccountId
                    };
                    accountReclassificationResult.Id = accountingReclassificationId;
                    accountReclassificationResult.Month = month;
                    accountReclassificationResult.SourceAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = sourceAccountingAccountId
                    };
                    accountReclassificationResult.Year = year;

                    SaveAccountingReclassification(accountReclassificationResult);

                    // Se inserta débito asiento a la contrapartida
                    accountingAccountId = reclassificationEntity.DestinationAccountingAccountId;

                    accountReclassificationResult.AccountingNature = GeneralLedgerModels.AccountingNatures.Debit;
                    accountReclassificationResult.DestinationAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = accountingAccountId
                    };

                    SaveAccountingReclassification(accountReclassificationResult);
                }

                ///////////////////////////////////////
                // Débito                            //
                ///////////////////////////////////////
                if (incomeAmount < 0)
                {
                    ReclassificationModels.AccountReclassificationResult accountReclassificationResult = new ReclassificationModels.AccountReclassificationResult();

                    accountReclassificationResult.AccountingNature = GeneralLedgerModels.AccountingNatures.Debit;
                    accountReclassificationResult.Amount = new CommonModels.Amount()
                    {
                        Currency = new CommonModels.Currency()
                        {
                            Id = currencyId
                        },
                        Value = incomeAmountDebit
                    };
                    accountReclassificationResult.ExchangeRate = new CommonModels.ExchangeRate()
                    {
                        SellAmount = exchangeRate,
                    };
                    accountReclassificationResult.LocalAmount = new CommonModels.Amount()
                    {
                        Value = amountDebit,
                    };
                    accountReclassificationResult.Analysis = new GeneralLedgerModels.Analysis()
                    {
                        AnalysisConcept = new GeneralLedgerModels.AnalysisConcept()
                        {
                            AnalysisConceptId = analysisConceptId
                        },
                        AnalysisId = analysisId,
                        Key = conceptKey
                    };

                    accountReclassificationResult.Branch = new CommonModels.Branch() { Id = branchId };
                    accountReclassificationResult.CostCenter = new GeneralLedgerModels.CostCenter()
                    {
                        CostCenterId = costCenterId
                    };
                    accountReclassificationResult.DestinationAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = accountingAccountId
                    };
                    accountReclassificationResult.Id = accountingReclassificationId;
                    accountReclassificationResult.Month = month;
                    accountReclassificationResult.SourceAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = sourceAccountingAccountId
                    };
                    accountReclassificationResult.Year = year;

                    SaveAccountingReclassification(accountReclassificationResult);

                    // Se inserta crédito asiento a la contrapartida
                    accountingAccountId = reclassificationEntity.DestinationAccountingAccountId;

                    accountReclassificationResult.AccountingNature = GeneralLedgerModels.AccountingNatures.Credit;
                    accountReclassificationResult.DestinationAccountingAccount = new GeneralLedgerModels.AccountingAccount()
                    {
                        AccountingAccountId = accountingAccountId
                    };

                    SaveAccountingReclassification(accountReclassificationResult);
                }
            }
        }

        /// <summary>
        /// GetReclassificationEntriesIncomeAmount
        /// </summary>
        /// <param name="analyticalEntries"></param>
        /// <returns>decimal</returns>
        private decimal GetReclassificationEntriesIncomeAmount(UIView analyticalEntries)
        {
            decimal incomeAmount = 0;

            foreach (DataRow entry in analyticalEntries)
            {
                if (Convert.ToInt32(entry["AccountingNature"]) == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Debit))
                {
                    incomeAmount += Convert.ToDecimal(entry["AmountValue"]);
                }
                else
                {
                    incomeAmount += Convert.ToDecimal(entry["AmountValue"]) * -1;
                }
            }

            return incomeAmount;
        }

        /// <summary>
        /// GetReclassificationEntriesAmount
        /// </summary>
        /// <param name="analyticalEntries"></param>
        /// <returns>decimal</returns>
        private decimal GetReclassificationEntriesAmount(UIView analyticalEntries)
        {
            decimal amount = 0;

            foreach (DataRow entry in analyticalEntries)
            {
                if (Convert.ToInt32(entry["AccountingNature"]) == Convert.ToInt32(GeneralLedgerModels.AccountingNatures.Debit))
                {
                    amount += Convert.ToDecimal(entry["AmountLocalValue"]);
                }
                else
                {
                    amount += Convert.ToDecimal(entry["AmountLocalValue"]) * -1;
                }
            }

            return amount;
        }

        #endregion AccountReclassification        

        #endregion Private Methods
    }
}
